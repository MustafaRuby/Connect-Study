<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">    <title>{{ materia.nome }} - Argomenti</title>    <!-- Modular CSS imports -->
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/animations.css">
    <link rel="stylesheet" href="/static/css/buttons.css">
    <link rel="stylesheet" href="/static/css/cards.css">
    <link rel="stylesheet" href="/static/css/modals.css">
    <link rel="stylesheet" href="/static/css/forms.css">
    <link rel="stylesheet" href="/static/css/search.css">
    <link rel="stylesheet" href="/static/css/markdown.css">
    <link rel="stylesheet" href="/static/css/allegati.css">
    <link rel="stylesheet" href="/static/css/context-menu.css">
    <link rel="stylesheet" href="/static/css/responsive.css">    <link rel="stylesheet" href="/static/css/argomenti-page.css">
    
    <!-- Local libraries CSS -->
    <link rel="stylesheet" href="/static/libs/katex/katex.min.css">
    <link rel="stylesheet" href="/static/libs/highlightjs/vs2015.min.css">
    <link rel="stylesheet" href="/static/libs/codemirror/codemirror.min.css">
    <link rel="stylesheet" href="/static/libs/codemirror/monokai.min.css">
    
    <!-- Local libraries JavaScript -->
    <script src="/static/libs/socketio/socket.io.min.js"></script>
    <script src="/static/libs/marked/marked.min.js"></script>
    
    <!-- CodeMirror for Markdown syntax highlighting -->
    <script src="/static/libs/codemirror/codemirror.min.js"></script>
    <script src="/static/libs/codemirror/overlay.min.js"></script>
    <script src="/static/libs/codemirror/xml.min.js"></script>
    <script src="/static/libs/codemirror/markdown.min.js"></script>
    <script src="/static/libs/codemirror/gfm.min.js"></script>
    <script src="/static/libs/codemirror/closebrackets.min.js"></script>
    <script src="/static/libs/codemirror/matchbrackets.min.js"></script>
    <script src="/static/libs/codemirror/active-line.min.js"></script>
    
    <!-- KaTeX JavaScript -->
    <script defer src="/static/libs/katex/katex.min.js"></script>
    <script defer src="/static/libs/katex/auto-render.min.js"></script>
    
    <!-- Highlight.js Core + Popular Languages -->
    <script src="/static/libs/highlightjs/highlight.min.js"></script>
    <script src="/static/libs/highlightjs/sql.min.js"></script>
    <script src="/static/libs/highlightjs/php.min.js"></script>
    <script src="/static/libs/highlightjs/python.min.js"></script>
    <script src="/static/libs/highlightjs/java.min.js"></script>
    <script src="/static/libs/highlightjs/cpp.min.js"></script>
    <script src="/static/libs/highlightjs/csharp.min.js"></script>
    <script src="/static/libs/highlightjs/go.min.js"></script>
    <script src="/static/libs/highlightjs/rust.min.js"></script>
    <script src="/static/libs/highlightjs/kotlin.min.js"></script>
    <script src="/static/libs/highlightjs/swift.min.js"></script>
    <script src="/static/libs/highlightjs/ruby.min.js"></script>
    <script src="/static/libs/highlightjs/perl.min.js"></script>
    <script src="/static/libs/highlightjs/r.min.js"></script>
    <script src="/static/libs/highlightjs/matlab.min.js"></script>
    <script src="/static/libs/highlightjs/shell.min.js"></script>
    <script src="/static/libs/highlightjs/powershell.min.js"></script>
    <script src="/static/libs/highlightjs/dockerfile.min.js"></script>
    <script src="/static/libs/highlightjs/yaml.min.js"></script>
    <script src="/static/libs/highlightjs/xml.min.js"></script>
    <script src="/static/libs/highlightjs/json.min.js"></script>
</head>
<body>
    <!-- Left Sidebar for Connections -->
    <div id="left-sidebar" class="left-sidebar">
        <div class="sidebar-toggle" onclick="toggleSidebar()">
            <span class="toggle-icon">üìã</span>
            <span class="toggle-text">Collegamenti</span>
        </div>
        
        <div class="sidebar-content">            <div class="sidebar-header">
                <h3>Collegamenti</h3>
                <button class="btn btn-sm add-btn" onclick="showCollegamentoModalEmpty()">
                    <span class="icon">‚ûï</span>
                    Nuovo
                </button>
            </div>
            
            <div class="sidebar-sections">
                <!-- Materie with their connections -->
                <div id="sidebar-materie" class="sidebar-materie">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Main content wrapper -->
    <div class="main-content">
        <!-- Context Menu per le card degli argomenti -->
    <div id="context-menu" class="context-menu">
        <div class="context-menu-item" data-action="edit">
            <span><img src="/static/icons/modify-icon.svg" width="16" height="16" style="vertical-align: middle;"> Modifica</span>
        </div>
        <div class="context-menu-item" data-action="delete">
            <span><img src="/static/icons/delete-icon.svg" width="16" height="16" style="vertical-align: middle;"> Elimina</span>
        </div>
    </div>    <!-- Modal di conferma eliminazione -->    
    <div id="confirm-delete-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Elimina argomento</h3>
                <button class="modal-close" onclick="document.getElementById('confirm-delete-modal').style.display = 'none'">&times;</button>
            </div>            <div class="modal-body">
                <p>Per eliminare <b id="delete-argomento-title"></b>, scrivi il titolo esatto qui sotto e conferma:</p>
                <input type="text" id="delete-argomento-input" placeholder="Titolo argomento">
                <div class="modal-buttons">
                    <button id="confirm-delete-btn" class="add-btn">Elimina</button>
                    <button id="cancel-delete-btn" class="cancel-btn">Annulla</button>
                </div>
            </div>
        </div>
    </div><div class="header">
        <div class="breadcrumb">
            <a href="/" class="breadcrumb-link">Materie</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">{{ materia.nome }}</span>
        </div>
        <h1 id="materia-title">{{ materia.nome }} - Argomenti</h1>
        <div class="header-buttons">
            <a href="/collegamenti/materia/{{ materia.id }}" class="btn btn-secondary">
                <span class="icon">üîó</span>
                Collegamenti
            </a>
            <button id="openArgomentoPopup" class="add-btn">Aggiungi argomento</button>
        </div>
    </div>

    <!-- Sezione ricerca e filtri -->
    <div class="search-filters-section">
        <div class="search-container">
            <div class="search-group">
                <label for="search-title">Cerca nel titolo:</label>
                <input type="text" id="search-title" placeholder="Cerca argomenti per titolo..." class="search-input">
            </div>
            <div class="search-group">
                <label for="search-content">Cerca nel contenuto:</label>
                <input type="text" id="search-content" placeholder="Cerca nel contenuto degli argomenti..." class="search-input">
            </div>
            <div class="search-group">
                <label for="filter-etichetta">Filtra per preparazione:</label>
                <select id="filter-etichetta" class="filter-select">
                    <option value="">Tutte le preparazioni</option>
                    <option value="scarsa-preparazione">Scarsa preparazione</option>
                    <option value="media-preparazione">Media preparazione</option>
                    <option value="buona-preparazione">Buona preparazione</option>
                </select>
            </div>
            <button id="clear-filters" class="clear-btn">Pulisci filtri</button>
        </div>
    </div>    <div id="argomenti-list" class="argomenti-list">
        {% for argomento in argomenti %}
        <div class="argomento-card" data-id="{{ argomento.id }}" data-href="/argomento/{{ argomento.id }}" style="border-left: 4px solid {{ argomento.colore }}" data-title="{{ argomento.titolo|e }}" data-content="{{ argomento.contenuto_md|e }}" data-etichetta="{{ argomento.etichetta_preparazione.replace(' ', '-') }}">
            <div class="argomento-header">
                <h3 class="argomento-title">{{ argomento.titolo }}</h3>
                <span class="etichetta etichetta-{{ argomento.etichetta_preparazione.replace(' ', '-') }}">
                    {{ argomento.etichetta_preparazione }}
                </span>
            </div>
            <div class="search-result" style="display: none;"></div>
            {% if argomento.contenuto_md %}
            <div class="argomento-preview">
                {{ argomento.contenuto_md[:200] }}...
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div><!-- Popup inserimento argomento -->
    <div id="argomentoPopup" class="popup-bg" style="display:none;">
        <div class="popup popup-large">
            <h2>Nuovo argomento</h2>
            <form id="addArgomentoForm" enctype="multipart/form-data">
                <input type="hidden" name="id_materia" value="{{ materia.id }}">
                
                <div class="form-group">
                    <label for="titolo">Titolo:</label>
                    <input type="text" name="titolo" id="titolo" placeholder="Titolo argomento" required autofocus>
                </div>
                
                <div class="form-group">
                    <label for="colore">Colore:</label>
                    <input type="color" name="colore" id="colore" value="#cccccc">
                </div>
                
                <div class="form-group">
                    <label for="etichetta_preparazione">Livello di preparazione:</label>
                    <select name="etichetta_preparazione" id="etichetta_preparazione">
                        <option value="scarsa preparazione">Scarsa preparazione</option>
                        <option value="media preparazione">Media preparazione</option>
                        <option value="buona preparazione">Buona preparazione</option>
                    </select>
                </div>                <div class="form-group">
                    <label for="contenuto_md">Contenuto (Markdown):</label>
                    <div id="add-markdown-editor-section" class="markdown-editor">
                        <div class="editor-tabs">
                            <button type="button" class="tab-btn active" data-tab="editor">Editor</button>
                            <button type="button" class="tab-btn" data-tab="preview">Anteprima</button>
                            
                            <!-- Editor size controls -->
                            <div class="editor-size-controls">
                                <button type="button" class="size-btn" id="add-fullscreen-toggle" title="Attiva/Disattiva modalit√† fullscreen">
                                    <span class="size-icon">‚õ∂</span>
                                </button>
                            </div>
                        </div>
                        <textarea name="contenuto_md" id="contenuto_md_add" placeholder="Inserisci il contenuto in formato Markdown..." rows="10"></textarea>
                        <div id="markdown-preview" class="markdown-preview" style="display:none;"></div>
                    </div>
                </div>
                  <div class="form-group">
                    <label for="file_content">Carica file (opzionale):</label>
                    <div class="file-upload-section">
                        <div class="file-input-wrapper">
                            <input type="file" name="file_content" id="file_content" accept=".docx,.pdf,.md" class="file-input-hidden">
                            <div class="file-input-display" id="file_display">
                                <span class="file-icon">üìé</span>
                                <span class="file-text">Scegli file o trascina qui</span>
                                <span class="file-subtext">Clicca per selezionare un file dal tuo computer</span>
                            </div>
                        </div>
                        <div class="file-upload-info">
                            <small>Formati supportati: .docx, .pdf, .md</small>
                        </div>
                        <div id="file-mode-section" class="file-mode-section" style="display:none;">
                            <label>Come inserire il contenuto del file:</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="file_mode" value="replace" checked>
                                    <span>Sostituisci tutto il contenuto</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="file_mode" value="prepend">
                                    <span>Inserisci all'inizio</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="file_mode" value="append">
                                    <span>Inserisci alla fine</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            
            <div class="popup-actions">
                <button type="submit" form="addArgomentoForm" class="add-btn">Aggiungi</button>
                <button type="button" id="closeArgomentoPopup" class="cancel-btn">Annulla</button>
            </div>
        </div>
    </div>
    
    <script>
        const socket = io();
        const materiaId = "{{ materia.id }}";
          // Function to clean preview text from markdown artifacts
        function cleanPreviewText(text) {
            if (!text) return '';
            
            return text
                // Remove markdown syntax
                .replace(/```[\w]*\n[\s\S]*?\n```/g, '[Code Block]')  // Code blocks
                .replace(/`([^`]+)`/g, '$1')  // Inline code
                .replace(/\*\*(.*?)\*\*/g, '$1')  // Bold
                .replace(/\*(.*?)\*/g, '$1')  // Italic
                .replace(/#{1,6}\s/g, '')  // Headers
                .replace(/!\[([^\]]*)\]\([^\)]*\)/g, '[Image: $1]')  // Images
                .replace(/\[([^\]]*)\]\([^\)]*\)/g, '$1')  // Links
                .replace(/^\s*[-*+]\s/gm, '‚Ä¢ ')  // List items
                .replace(/^\s*\d+\.\s/gm, '‚Ä¢ ')  // Numbered lists
                .replace(/>\s/g, '')  // Blockquotes
                .replace(/\$\$[\s\S]*?\$\$/g, '[Math Formula]')  // Math blocks
                .replace(/\$([^$\n]+)\$/g, '[Math: $1]')  // Inline math
                .replace(/\n+/g, ' ')  // Multiple newlines to single space
                .replace(/\s+/g, ' ')  // Multiple spaces to single space
                .replace(/[^\w\s\u00C0-\u024F\u1E00-\u1EFF.,!?;:()\[\]{}'"¬´¬ª""''‚Äì‚Äî]/g, '')  // Remove special chars but keep accented letters and basic punctuation
                .trim();
        }

        // Enhanced function to create clean text preview
        function createCleanPreview(content, maxLength = 200) {
            if (!content) return '';
            
            const cleanText = cleanPreviewText(content);
            if (cleanText.length <= maxLength) {
                return cleanText;
            }
            
            // Find a good breaking point near the max length
            let breakPoint = maxLength;
            const lastSpace = cleanText.lastIndexOf(' ', maxLength);
            const lastPunctuation = Math.max(
                cleanText.lastIndexOf('.', maxLength),
                cleanText.lastIndexOf('!', maxLength),
                cleanText.lastIndexOf('?', maxLength)
            );
            
            if (lastPunctuation > maxLength - 50) {
                breakPoint = lastPunctuation + 1;
            } else if (lastSpace > maxLength - 30) {
                breakPoint = lastSpace;
            }
            
            return cleanText.substring(0, breakPoint).trim() + '...';
        }

        // Funzioni per parsing sicuro del markdown con KaTeX e Highlight.js
        function parseMarkdownSafely(content) {
            if (!content || !content.trim()) {
                return '';
            }
            
            console.log('üîç Inizio parsing del contenuto con KaTeX e Highlight.js...');
            
            try {
                // Step 1: Parse markdown content
                const htmlContent = marked.parse(content);
                
                // Step 2: Create temporary container for KaTeX rendering
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                
                // Step 3: Apply syntax highlighting with highlight.js
                console.log('üé® Applicando syntax highlighting...');
                tempDiv.querySelectorAll('pre code').forEach((block) => {
                    // Rimuovi eventuali classi esistenti di highlight.js
                    block.className = block.className.replace(/hljs\S*/g, '');
                    
                    // Applica la syntax highlighting
                    hljs.highlightElement(block);
                    
                    // Aggiungi una classe per lo styling personalizzato
                    block.classList.add('hljs-enhanced');
                });
                
                // Step 4: Render math with KaTeX
                console.log('üßÆ Rendering formule matematiche...');
                renderMathInElement(tempDiv, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "\\[", right: "\\]", display: true},
                        {left: "$", right: "$", display: false},
                        {left: "\\(", right: "\\)", display: false}
                    ],
                    throwOnError: false,
                    errorColor: '#cc0000',
                    strict: false,
                    trust: false
                });
                
                console.log('‚úÖ Parser con KaTeX e Highlight.js riuscito');
                return tempDiv.innerHTML;
                
            } catch (error) {
                console.error('‚ùå Errore nel parsing avanzato:', error);
                // Fallback to basic markdown without math but with highlighting
                try {
                    const basicHtml = marked.parse(content);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = basicHtml;
                    
                    // Apply only syntax highlighting in fallback
                    tempDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                        block.classList.add('hljs-enhanced');
                    });
                    
                    return tempDiv.innerHTML;
                } catch (fallbackError) {
                    console.error('‚ùå Anche il fallback √® fallito:', fallbackError);
                    return parseWithBasicFallback(content);
                }
            }
        }
          function parseWithBasicFallback(content) {
            console.log('üîß Usando fallback b√°sico con syntax highlighting...');
            
            // Very basic markdown parsing without math
            let html = content
                // Code blocks - preserve language hints for highlighting
                .replace(/```(\w+)?\s*\n([\s\S]*?)\n```/g, function(match, lang, code) {
                    const langClass = lang ? ` class="language-${lang}"` : '';
                    return `<pre><code${langClass}>${code}</code></pre>`;
                })
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Bold and italic
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Remove math expressions that can't be rendered
                .replace(/\$\$[\s\S]*?\$\$/g, '<span style="background:#ffe6e6;padding:2px 4px;border-radius:3px;">[Formula matematica]</span>')
                .replace(/\$([^$\n]+)\$/g, '<span style="background:#ffe6e6;padding:2px 4px;border-radius:3px;">[Math: $1]</span>')
                // Line breaks
                .replace(/\n\n+/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Wrap in paragraphs
            if (!html.includes('<h') && !html.includes('<p>')) {
                html = '<p>' + html + '</p>';
            }
            
            // Apply syntax highlighting to code blocks
            try {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                tempDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                    block.classList.add('hljs-enhanced');
                });
                
                html = tempDiv.innerHTML;
                console.log('‚úÖ Syntax highlighting applicato al fallback');
            } catch (highlightError) {
                console.warn('‚ö†Ô∏è Errore nell\'applicazione del syntax highlighting:', highlightError);
            }
              return html;
        }
          function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Function to show new collegamento modal (redirects to collegamenti page)
        function showCollegamentoModalEmpty() {
            window.location.href = '/collegamenti';
        }

        // Sidebar functions for collegamenti
        function loadSidebarConnections() {
            fetch('/api/collegamenti')
                .then(response => response.json())
                .then(collegamenti => {
                    updateSidebarConnections(collegamenti);
                })
                .catch(error => console.error('Error loading sidebar connections:', error));
        }        function updateSidebarConnections(collegamenti) {
            const sidebarMaterie = document.getElementById('sidebar-materie');
            
            // Group connections by materia
            const materieMap = new Map();
            
            collegamenti.forEach(collegamento => {
                // Add to materia 1
                const materia1 = collegamento.materia1_nome;
                if (!materieMap.has(materia1)) {
                    materieMap.set(materia1, {
                        nome: materia1,
                        colore: collegamento.materia1_colore,
                        collegamenti: []
                    });
                }
                materieMap.get(materia1).collegamenti.push(collegamento);
                
                // Add to materia 2 if different
                const materia2 = collegamento.materia2_nome;
                if (materia2 !== materia1) {
                    if (!materieMap.has(materia2)) {
                        materieMap.set(materia2, {
                            nome: materia2,
                            colore: collegamento.materia2_colore,
                            collegamenti: []
                        });
                    }
                    materieMap.get(materia2).collegamenti.push(collegamento);
                }
            });
            
            // Generate sidebar HTML
            sidebarMaterie.innerHTML = '';
            
            if (materieMap.size === 0) {
                sidebarMaterie.innerHTML = '<p class="no-connections">Nessun collegamento trovato</p>';
                return;
            }
            
            materieMap.forEach((materiaData, materiaNome) => {
                const materiaDiv = document.createElement('div');
                materiaDiv.className = 'sidebar-materia';
                
                materiaDiv.innerHTML = `
                    <div class="sidebar-materia-header" onclick="toggleMateriaConnections(this)">
                        <div class="sidebar-materia-title">
                            <span class="sidebar-materia-badge" style="background-color: ${materiaData.colore}"></span>
                            ${materiaNome}
                        </div>
                        <span class="sidebar-materia-toggle">‚ñ∂</span>
                    </div>
                    <div class="sidebar-search-group">
                        <div class="sidebar-search">
                            <input type="text" class="sidebar-search-input" placeholder="Cerca collegamento..." oninput="filterCollegamenti(this, 'collegamento')">
                            <img src="/static/icons/search-icon.svg" class="sidebar-search-icon" width="16" height="16">
                        </div>
                        <div class="sidebar-search">
                            <input type="text" class="sidebar-search-input" placeholder="Cerca argomento..." oninput="filterCollegamenti(this, 'argomento')">
                            <img src="/static/icons/search-icon.svg" class="sidebar-search-icon" width="16" height="16">
                        </div>
                    </div>
                    <div class="sidebar-collegamenti">
                        ${materiaData.collegamenti.map(conn => `
                            <div class="sidebar-collegamento" data-titolo="${conn.titolo.toLowerCase()}" data-argomenti="${conn.argomento1_titolo.toLowerCase()} ${conn.argomento2_titolo.toLowerCase()}" onclick="viewCollegamento(${conn.id})">
                                <div class="collegamento-title">${conn.titolo}</div>
                                <div class="collegamento-endpoints">
                                    ${conn.argomento1_titolo} ‚Üî ${conn.argomento2_titolo}
                                </div>
                                <div class="collegamento-quality quality-${conn.etichetta_qualita.replace(/\s+/g, '-').replace('collegamento-', '')}">${conn.etichetta_qualita}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                sidebarMaterie.appendChild(materiaDiv);
            });
        }

        function toggleMateriaConnections(headerElement) {
            const materiaDiv = headerElement.parentElement;
            materiaDiv.classList.toggle('expanded');
        }        function viewCollegamento(collegamentoId) {
            showSidebarCollegamentoModal(collegamentoId);
        }        function filterCollegamenti(inputElement, filterType) {
            const searchTerm = inputElement.value.toLowerCase().trim();
            const materiaDiv = inputElement.closest('.sidebar-materia');
            const collegamenti = materiaDiv.querySelectorAll('.sidebar-collegamento');
            
            collegamenti.forEach(collegamento => {
                let shouldShow = false;
                
                // Get original data if not stored
                if (!collegamento.originalData) {
                    const titleElement = collegamento.querySelector('.collegamento-title');
                    const endpointsElement = collegamento.querySelector('.collegamento-endpoints');
                    collegamento.originalData = {
                        title: titleElement ? titleElement.textContent : '',
                        endpoints: endpointsElement ? endpointsElement.textContent : ''
                    };
                }
                
                if (filterType === 'collegamento') {
                    // Filter by connection title
                    const titolo = collegamento.getAttribute('data-titolo');
                    shouldShow = titolo.includes(searchTerm);
                    
                    // Highlight title if showing and search term exists
                    const titleElement = collegamento.querySelector('.collegamento-title');
                    if (titleElement) {
                        if (shouldShow && searchTerm) {
                            titleElement.innerHTML = highlightText(collegamento.originalData.title, searchTerm);
                        } else {
                            titleElement.textContent = collegamento.originalData.title;
                        }
                    }
                } else if (filterType === 'argomento') {
                    // Filter by argument titles
                    const argomenti = collegamento.getAttribute('data-argomenti');
                    shouldShow = argomenti.includes(searchTerm);
                    
                    // Highlight endpoints if showing and search term exists
                    const endpointsElement = collegamento.querySelector('.collegamento-endpoints');
                    if (endpointsElement) {
                        if (shouldShow && searchTerm) {
                            endpointsElement.innerHTML = highlightText(collegamento.originalData.endpoints, searchTerm);
                        } else {
                            endpointsElement.textContent = collegamento.originalData.endpoints;
                        }
                    }
                }
                
                collegamento.style.display = shouldShow ? 'block' : 'none';
            });
        }

        // Gestione popup argomento
        document.getElementById('openArgomentoPopup').addEventListener('click', function() {
            document.getElementById('argomentoPopup').style.display = 'flex';
        });

        document.getElementById('closeArgomentoPopup').addEventListener('click', function() {
            document.getElementById('argomentoPopup').style.display = 'none';
            document.getElementById('addArgomentoForm').reset();
        });        // Gestione form argomento
        document.getElementById('addArgomentoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch('/add_argomento', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    document.getElementById('argomentoPopup').style.display = 'none';
                    this.reset();
                    // Reset della sezione file
                    document.getElementById('file-mode-section').style.display = 'none';
                }
            });
        });

        // Gestione selezione file
        document.getElementById('file_content').addEventListener('change', function() {
            const fileModeSection = document.getElementById('file-mode-section');
            if (this.files.length > 0) {
                fileModeSection.style.display = 'block';
            } else {
                fileModeSection.style.display = 'none';
            }
        });        // Gestione tabs markdown
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tab = this.dataset.tab;
                
                // Reset tabs
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const textarea = document.getElementById('contenuto_md_add');
                const preview = document.getElementById('markdown-preview');
                
                if (!textarea || !preview) return;
                
                // Find CodeMirror wrapper
                const codeMirrorWrapper = textarea.nextElementSibling;
                  if (tab === 'editor') {
                    if (codeMirrorWrapper && codeMirrorWrapper.classList.contains('CodeMirror')) {
                        // CodeMirror is available, hide textarea and show CodeMirror
                        textarea.style.display = 'none';
                        codeMirrorWrapper.style.display = 'block';
                        // Refresh CodeMirror when shown
                        const cm = codeMirrorWrapper.CodeMirror;
                        if (cm) {
                            setTimeout(() => cm.refresh(), 10);
                        }
                    } else {
                        // No CodeMirror, show textarea
                        textarea.style.display = 'block';
                    }
                    preview.style.display = 'none';                } else {
                    if (codeMirrorWrapper && codeMirrorWrapper.classList.contains('CodeMirror')) {
                        // Hide both textarea and CodeMirror, show preview
                        textarea.style.display = 'none';
                        codeMirrorWrapper.style.display = 'none';
                        // Get content from CodeMirror
                        const cm = codeMirrorWrapper.CodeMirror;
                        const content = cm ? cm.getValue() : textarea.value;
                        preview.innerHTML = parseMarkdownSafely(content) || '<p>Nessun contenuto da visualizzare</p>';
                    } else {
                        // Hide textarea, show preview
                        textarea.style.display = 'none';
                        preview.innerHTML = parseMarkdownSafely(textarea.value) || '<p>Nessun contenuto da visualizzare</p>';
                    }
                    preview.style.display = 'block';
                }
            });
        });// Aggiornamento real-time argomenti
        socket.on('update_argomenti', function(data) {
            if (data.id_materia == materiaId) {
                fetch(`/api/argomenti/${materiaId}`)
                    .then(response => response.json())
                    .then(argomenti => {
                        const container = document.getElementById('argomenti-list');
                        container.innerHTML = '';
                        
                        // Reset allArgomenti array
                        allArgomenti = [];
                          
                        argomenti.forEach(argomento => {
                            const card = document.createElement('div');
                            card.className = 'argomento-card';
                            card.dataset.id = argomento.id;
                            card.dataset.href = `/argomento/${argomento.id}`;
                            card.dataset.title = argomento.titolo;
                            card.dataset.content = argomento.contenuto_md || '';
                            card.dataset.etichetta = argomento.etichetta_preparazione.replace(/ /g, '-');
                            card.style.borderLeft = `4px solid ${argomento.colore}`;                                let preview = '';
                            let cleanPreviewText = '';
                            if (argomento.contenuto_md) {
                                // Create clean preview text
                                cleanPreviewText = createCleanPreview(argomento.contenuto_md);
                                preview = `<div class="argomento-preview">${escapeHtml(cleanPreviewText)}</div>`;
                            }
                            
                            card.innerHTML = `
                                <div class="argomento-header">
                                    <h3 class="argomento-title">${argomento.titolo}</h3>
                                    <span class="etichetta etichetta-${argomento.etichetta_preparazione.replace(/ /g, '-')}">${argomento.etichetta_preparazione}</span>
                                </div>
                                <div class="search-result" style="display: none;"></div>
                                ${preview}
                            `;                            
                            container.appendChild(card);
                            
                            // Add to allArgomenti array for search functionality
                            allArgomenti.push({
                                element: card,
                                id: argomento.id,
                                title: argomento.titolo || '',
                                content: argomento.contenuto_md || '',
                                etichetta: argomento.etichetta_preparazione.replace(/ /g, '-'),
                                originalTitle: argomento.titolo,
                                originalPreview: cleanPreviewText
                            });
                        });
                        
                        // Re-apply current search/filters after update
                        if (document.getElementById('search-title').value || 
                            document.getElementById('search-content').value || 
                            document.getElementById('filter-etichetta').value) {
                            performSearch();
                        }
                    });
            }
        });// Click su argomento per aprire dettagli
        document.addEventListener('click', function(e) {
            const card = e.target.closest('.argomento-card');
            if (card && card.dataset.href) {
                window.location.href = card.dataset.href;
            }
        });// Funzione per gestire il contrasto del titolo della materia
        function setTitleContrast() {
            const materiaColor = '{{ materia.colore }}';
            const title = document.getElementById('materia-title');
            
            // Funzione per calcolare la luminosit√†
            function getLuminance(hexColor) {
                const hex = hexColor.replace('#', '');
                const r = parseInt(hex.substr(0, 2), 16);
                const g = parseInt(hex.substr(2, 2), 16);
                const b = parseInt(hex.substr(4, 2), 16);
                return (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            }
            
            // Funzione per scurire un colore
            function darkenColor(hexColor, factor = 0.6) {
                const hex = hexColor.replace('#', '');
                const r = Math.floor(parseInt(hex.substr(0, 2), 16) * factor);
                const g = Math.floor(parseInt(hex.substr(2, 2), 16) * factor);
                const b = Math.floor(parseInt(hex.substr(4, 2), 16) * factor);
                return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }
            
            const luminance = getLuminance(materiaColor);
            
            // Lo sfondo della pagina √® sempre chiaro, quindi gestiamo solo per quello
            if (luminance > 0.6) {
                // Colore troppo chiaro per uno sfondo chiaro, usa una versione molto pi√π scura
                const darkerColor = darkenColor(materiaColor, 0.3);
                title.style.color = darkerColor;
                title.classList.add('materia-title-colored');
            } else if (luminance > 0.4) {
                // Colore medio-chiaro, scurire leggermente
                const darkerColor = darkenColor(materiaColor, 0.6);
                title.style.color = darkerColor;
                title.classList.add('materia-title-colored');
            } else {
                // Colore gi√† abbastanza scuro per buon contrasto su sfondo chiaro
                title.style.color = materiaColor;
                title.classList.add('materia-title-colored');
            }
        }
          // Applica il contrasto al caricamento della pagina
        setTitleContrast();        // Search and filter functionality
        let searchTimeout;
        let allArgomenti = [];        // Store original data on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize CodeMirror for markdown editing
            let addArgomentoEditor;
              function initCodeMirror() {
                // Check if CodeMirror is available
                if (typeof CodeMirror === 'undefined') {
                    console.log('CodeMirror not yet loaded, retrying...');
                    setTimeout(initCodeMirror, 100);
                    return;
                }
                
                const textareaAdd = document.getElementById('contenuto_md_add');
                if (textareaAdd && !addArgomentoEditor) {                    addArgomentoEditor = CodeMirror.fromTextArea(textareaAdd, {
                        mode: 'gfm',
                        theme: 'monokai',
                        lineNumbers: true,
                        lineWrapping: true,
                        autoCloseBrackets: true,
                        matchBrackets: true,
                        styleActiveLine: true,
                        placeholder: 'Inserisci il contenuto in formato Markdown...',
                        extraKeys: {
                            "Ctrl-Space": "autocomplete",
                            "F11": function(cm) {
                                cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                            },
                            "Esc": function(cm) {
                                if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
                            }
                        }
                    });
                      // Update textarea when CodeMirror changes
                    addArgomentoEditor.on('change', function(cm) {
                        textareaAdd.value = cm.getValue();
                        // Trigger preview update if needed
                        updateMarkdownPreview();
                    });
                }
            }
            
            // Function to update markdown preview (can be extended if preview tabs are added)
            function updateMarkdownPreview() {
                // This function can be extended to show real-time preview
                // For now, it ensures the textarea value is synced with CodeMirror
                const textareaAdd = document.getElementById('contenuto_md_add');
                if (textareaAdd && addArgomentoEditor) {
                    textareaAdd.value = addArgomentoEditor.getValue();
                }
            }
              // Initialize CodeMirror when popup is shown
            const argomentoPopup = document.getElementById('argomentoPopup');
            if (argomentoPopup) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            const isVisible = argomentoPopup.style.display !== 'none';
                            if (isVisible) {
                                setTimeout(initCodeMirror, 100); // Small delay to ensure DOM is ready
                            }
                        }
                    });
                });
                observer.observe(argomentoPopup, { attributes: true });            }
            
            // Tab switching functionality for markdown editor
            setupTabSwitching();
            
            // Initialize editor size controls for add argument form
            setupAddEditorSizeControls();
        });
        
        function setupTabSwitching() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('tab-btn')) {
                    const clickedTab = e.target;
                    const tabContainer = clickedTab.closest('.markdown-editor');
                    const tabType = clickedTab.dataset.tab;
                    
                    if (!tabContainer) return;
                    
                    // Remove active class from all tabs in this container
                    tabContainer.querySelectorAll('.tab-btn').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    // Add active class to clicked tab
                    clickedTab.classList.add('active');
                    
                    // Get editor elements
                    const textarea = tabContainer.querySelector('textarea');
                    const previewDiv = tabContainer.querySelector('.markdown-preview');
                    
                    // Find CodeMirror wrapper
                    const codeMirrorWrapper = textarea.nextElementSibling;
                      if (tabType === 'editor') {
                        // Show appropriate editor, hide preview
                        if (codeMirrorWrapper && codeMirrorWrapper.classList.contains('CodeMirror')) {
                            // CodeMirror is available, hide textarea and show CodeMirror
                            textarea.style.display = 'none';
                            codeMirrorWrapper.style.display = 'block';
                            // Refresh CodeMirror when shown
                            const cm = codeMirrorWrapper.CodeMirror;
                            if (cm) {
                                setTimeout(() => cm.refresh(), 10);
                            }
                        } else {
                            // No CodeMirror, show textarea
                            textarea.style.display = 'block';
                        }
                        if (previewDiv) {
                            previewDiv.style.display = 'none';
                        }
                    } else if (tabType === 'preview') {
                        // Hide editor, show preview
                        textarea.style.display = 'none';
                        if (codeMirrorWrapper && codeMirrorWrapper.classList.contains('CodeMirror')) {
                            codeMirrorWrapper.style.display = 'none';
                        }
                        if (previewDiv) {
                            previewDiv.style.display = 'block';
                            // Update preview content
                            const content = textarea.value;
                            if (content.trim()) {
                                // Simple markdown to HTML conversion for preview
                                const htmlContent = convertMarkdownToHtml(content);
                                previewDiv.innerHTML = htmlContent;
                            } else {
                                previewDiv.innerHTML = '<p class="text-muted">Nessun contenuto da visualizzare in anteprima</p>';
                            }
                        }
                    }
                }
            });
        }
        
        function convertMarkdownToHtml(markdown) {
            // Simple markdown to HTML conversion
            let html = markdown
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Bold
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/__(.*?)__/gim, '<strong>$1</strong>')
                // Italic
                .replace(/\*(.*)\*/gim, '<em>$1</em>')
                .replace(/_(.*?)_/gim, '<em>$1</em>')
                // Code blocks
                .replace(/```([\s\S]*?)```/gim, '<pre><code>$1</code></pre>')
                // Inline code
                .replace(/`(.*?)`/gim, '<code>$1</code>')
                // Lists
                .replace(/^\* (.*$)/gim, '<ul><li>$1</li></ul>')
                .replace(/^\- (.*$)/gim, '<ul><li>$1</li></ul>')
                .replace(/^\d+\. (.*$)/gim, '<ol><li>$1</li></ol>')
                // Line breaks
                .replace(/\n/gim, '<br>');
            
            // Clean up nested lists
            html = html.replace(/<\/ul>\s*<ul>/g, '').replace(/<\/ol>\s*<ol>/g, '');
              return html;
        }
        
        // Store all argomenti data for filtering
            document.querySelectorAll('.argomento-card').forEach(function(card) {
                const titleElement = card.querySelector('.argomento-title');
                const previewElement = card.querySelector('.argomento-preview');
                
                // Create clean preview text for search
                const rawContent = card.dataset.content || '';
                const cleanPreview = createCleanPreview(rawContent);
                
                // Update preview element with clean text
                if (previewElement && rawContent) {
                    previewElement.textContent = cleanPreview;
                }
                
                allArgomenti.push({
                    element: card,
                    id: card.dataset.id,
                    title: card.dataset.title || '',
                    content: rawContent,
                    etichetta: card.dataset.etichetta || '',
                    originalTitle: titleElement ? titleElement.textContent : '',
                    originalPreview: cleanPreview
                });
            });
              // Handle existing preview texts that are already loaded in the template
            document.querySelectorAll('.argomento-preview').forEach(function(element) {
                const card = element.closest('.argomento-card');
                const rawContent = card ? card.dataset.content : '';
                
                if (rawContent) {
                    const cleanPreview = createCleanPreview(rawContent);
                    element.textContent = cleanPreview;
                    
                    // Update the stored preview in allArgomenti
                    const argomento = allArgomenti.find(arg => arg.element === card);
                    if (argomento) {
                        argomento.originalPreview = cleanPreview;
                    }
                }
            });            // Setup search event listeners
            setupSearchListeners();
            
            // Load sidebar connections
            loadSidebarConnections();
            
            // Enhanced file input handling
            const fileInput = document.getElementById('file_content');
            const fileDisplay = document.getElementById('file_display');
            
            if (fileInput && fileDisplay) {
                // Make the display area clickable
                fileDisplay.addEventListener('click', function() {
                    fileInput.click();
                });

                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const wrapper = fileInput.closest('.file-input-wrapper');
                    
                    if (file) {
                        wrapper.classList.add('has-file');
                        fileDisplay.querySelector('.file-icon').textContent = '‚úÖ';
                        fileDisplay.querySelector('.file-text').textContent = `File selezionato: ${file.name}`;
                        fileDisplay.querySelector('.file-subtext').textContent = 'Clicca per cambiare file';
                        fileInput.title = `File selezionato: ${file.name}`;
                    } else {
                        wrapper.classList.remove('has-file');
                        fileDisplay.querySelector('.file-icon').textContent = 'üìé';
                        fileDisplay.querySelector('.file-text').textContent = 'Scegli file o trascina qui';
                        fileDisplay.querySelector('.file-subtext').textContent = 'Clicca per selezionare un file dal tuo computer';
                        fileInput.title = '';
                    }
                });

                // Drag and drop support
                fileDisplay.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    fileDisplay.style.borderColor = '#4f8cff';
                    fileDisplay.style.backgroundColor = '#f0f4ff';
                });

                fileDisplay.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    fileDisplay.style.borderColor = '';
                    fileDisplay.style.backgroundColor = '';
                });

                fileDisplay.addEventListener('drop', function(e) {
                    e.preventDefault();
                    fileDisplay.style.borderColor = '';
                    fileDisplay.style.backgroundColor = '';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        fileInput.dispatchEvent(new Event('change'));
                    }
                });
            }
        
        
        function setupSearchListeners() {
            const searchTitle = document.getElementById('search-title');
            const searchContent = document.getElementById('search-content');
            const filterEtichetta = document.getElementById('filter-etichetta');
            const clearFilters = document.getElementById('clear-filters');
            
            // Search with debounce
            function debounceSearch() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(performSearch, 300);
            }
            
            searchTitle.addEventListener('input', debounceSearch);
            searchContent.addEventListener('input', debounceSearch);
            filterEtichetta.addEventListener('change', performSearch);
            
            clearFilters.addEventListener('click', function() {
                searchTitle.value = '';
                searchContent.value = '';
                filterEtichetta.value = '';
                performSearch();
            });
        }
        
        function performSearch() {
            const titleQuery = document.getElementById('search-title').value.toLowerCase().trim();
            const contentQuery = document.getElementById('search-content').value.toLowerCase().trim();
            const etichettaFilter = document.getElementById('filter-etichetta').value;
            
            let visibleCount = 0;
            
            allArgomenti.forEach(function(argomento) {
                let isVisible = true;
                
                // Title search
                if (titleQuery && !argomento.title.toLowerCase().includes(titleQuery)) {
                    isVisible = false;
                }
                
                // Content search
                if (contentQuery) {
                    const cleanContent = cleanPreviewText(argomento.content).toLowerCase();
                    if (!cleanContent.includes(contentQuery)) {
                        isVisible = false;
                    }
                }
                
                // Etichetta filter
                if (etichettaFilter && argomento.etichetta !== etichettaFilter) {
                    isVisible = false;
                }
                
                // Show/hide element
                if (isVisible) {
                    argomento.element.style.display = 'block';
                    visibleCount++;
                    
                    // Highlight matches
                    highlightMatches(argomento, titleQuery, contentQuery);
                    
                    // Show search result snippet if content search
                    if (contentQuery) {
                        showSearchSnippet(argomento, contentQuery);
                    } else {
                        hideSearchSnippet(argomento);
                    }
                } else {
                    argomento.element.style.display = 'none';
                }
            });
            
            // Update results info
            updateSearchResults(visibleCount, allArgomenti.length);
        }          function highlightMatches(argomento, titleQuery, contentQuery) {
            const titleElement = argomento.element.querySelector('.argomento-title');
            const previewElement = argomento.element.querySelector('.argomento-preview');
            
            // Reset to original content
            if (titleElement) {
                titleElement.textContent = argomento.originalTitle || '';
            }
            if (previewElement) {
                previewElement.textContent = argomento.originalPreview || '';
            }
            
            // Highlight title matches
            if (titleQuery && titleElement && argomento.originalTitle) {
                const highlightedTitle = highlightText(argomento.originalTitle, titleQuery);
                titleElement.innerHTML = highlightedTitle;
            }
            
            // Highlight content matches in preview
            if (contentQuery && previewElement && argomento.originalPreview) {
                const highlightedText = highlightText(argomento.originalPreview, contentQuery);
                previewElement.innerHTML = highlightedText;
            }
        }
        
        function highlightText(text, query) {
            if (!query || !text) return text;
            
            const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
            return text.replace(regex, '<mark class="search-highlight">$1</mark>');
        }
        
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
          function showSearchSnippet(argomento, query) {
            const searchResultElement = argomento.element.querySelector('.search-result');
            
            if (!searchResultElement) {
                return;
            }
            
            const cleanContent = cleanPreviewText(argomento.content);
            
            if (!cleanContent) {
                hideSearchSnippet(argomento);
                return;
            }
            
            // Find the position of the query in the content
            const lowerContent = cleanContent.toLowerCase();
            const queryPos = lowerContent.indexOf(query.toLowerCase());
            
            if (queryPos === -1) {
                hideSearchSnippet(argomento);
                return;
            }
            
            // Extract snippet around the found text
            const snippetStart = Math.max(0, queryPos - 50);
            const snippetEnd = Math.min(cleanContent.length, queryPos + query.length + 50);
            let snippet = cleanContent.substring(snippetStart, snippetEnd);
            
            // Add ellipsis if needed
            if (snippetStart > 0) snippet = '...' + snippet;
            if (snippetEnd < cleanContent.length) snippet = snippet + '...';
            
            // Highlight the query in the snippet
            const highlightedSnippet = highlightText(snippet, query);
            
            searchResultElement.innerHTML = `
                <div class="search-snippet">
                    <strong>Trovato in:</strong> ${highlightedSnippet}
                </div>
            `;
            searchResultElement.style.display = 'block';
        }
          function hideSearchSnippet(argomento) {
            const searchResultElement = argomento.element.querySelector('.search-result');
            if (searchResultElement) {
                searchResultElement.style.display = 'none';
            }
        }
        
        function updateSearchResults(visibleCount, totalCount) {
            // Remove existing results info
            const existingInfo = document.querySelector('.search-results-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            // Add new results info
            if (visibleCount !== totalCount) {
                const resultsInfo = document.createElement('div');
                resultsInfo.className = 'search-results-info';
                resultsInfo.innerHTML = `
                    <span class="results-count">
                        Mostrati ${visibleCount} di ${totalCount} argomenti
                    </span>
                `;
                  const argomentiList = document.getElementById('argomenti-list');
                argomentiList.parentNode.insertBefore(resultsInfo, argomentiList);
            }
        }

        // Context Menu Management
        let currentContextCard = null;
        const contextMenu = document.getElementById('context-menu');
        const confirmModal = document.getElementById('confirm-delete-modal');

        // Right-click on argomento cards
        document.addEventListener('contextmenu', function(e) {
            const card = e.target.closest('.argomento-card');
            if (card) {
                e.preventDefault();
                currentContextCard = card;
                showContextMenu(e.clientX, e.clientY);
            }
        });

        // Hide context menu on click elsewhere
        document.addEventListener('click', function(e) {
            if (!contextMenu.contains(e.target)) {
                hideContextMenu();
            }
        });        // Context menu actions
        document.querySelectorAll('.context-menu-item').forEach(item => {
            item.addEventListener('click', function() {
                const action = this.dataset.action;
                if (currentContextCard) {
                    if (action === 'edit') {
                        const argomentoId = currentContextCard.dataset.id;
                        window.location.href = `/argomento/${argomentoId}?edit=true`;
                    } else if (action === 'delete') {
                        showDeleteConfirmation();
                    }
                }
                hideContextMenu();
            });
        });        // Delete confirmation modal
        document.getElementById('confirm-delete-btn').addEventListener('click', function() {
            if (currentContextCard) {
                const argomentoTitle = currentContextCard.querySelector('h3').textContent;
                const inputValue = document.getElementById('delete-argomento-input').value.trim();
                
                if (inputValue !== argomentoTitle) {
                    alert('Il titolo inserito non corrisponde.');
                    return;
                }
                  const argomentoId = currentContextCard.dataset.id;
                deleteArgomento(argomentoId)
                    .then(() => {
                        hideDeleteConfirmation();
                    })
                    .catch(() => {
                        hideDeleteConfirmation();
                    });
            }
        });

        document.getElementById('cancel-delete-btn').addEventListener('click', function() {
            hideDeleteConfirmation();
        });

        function showContextMenu(x, y) {
            contextMenu.style.display = 'block';
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
            
            // Ensure menu stays within viewport
            const rect = contextMenu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                contextMenu.style.left = (x - rect.width) + 'px';
            }
            if (rect.bottom > window.innerHeight) {
                contextMenu.style.top = (y - rect.height) + 'px';
            }
        }        function hideContextMenu() {
            contextMenu.style.display = 'none';
        }function showDeleteConfirmation() {
            const argomentoTitle = currentContextCard.querySelector('h3').textContent;
            document.getElementById('delete-argomento-title').textContent = argomentoTitle;
            document.getElementById('delete-argomento-input').placeholder = argomentoTitle;
            document.getElementById('delete-argomento-input').value = '';
            confirmModal.style.display = 'flex';
        }        function hideDeleteConfirmation() {
            confirmModal.style.display = 'none';
            document.getElementById('delete-argomento-input').value = '';
            currentContextCard = null;
        }function deleteArgomento(id) {
            return fetch(`/delete_argomento/${id}`, {
                method: 'DELETE'
            }).then(response => {
                if (response.ok) {
                    // Remove card from DOM
                    currentContextCard.remove();
                    
                    // Update allArgomenti array to remove deleted item
                    const cardIndex = allArgomenti.findIndex(arg => arg.element === currentContextCard);
                    if (cardIndex !== -1) {
                        allArgomenti.splice(cardIndex, 1);
                    }
                    
                    // Update search results
                    const allCards = document.querySelectorAll('.argomento-card');
                    updateSearchResults(allCards.length, allCards.length);
                    return Promise.resolve();
                } else {
                    alert('Errore durante l\'eliminazione dell\'argomento');
                    return Promise.reject(new Error('Delete failed'));
                }
            }).catch(error => {
                console.error('Errore:', error);
                alert('Errore durante l\'eliminazione dell\'argomento');                return Promise.reject(error);
            });        }        // Enhanced file input handling - moved to main DOMContentLoaded block

        // === SIDEBAR TOGGLE ===
function toggleSidebar() {
    const sidebar = document.getElementById('left-sidebar');
    const mainContent = document.querySelector('.main-content');
    const toggleIcon = document.querySelector('.toggle-icon');
    if (!sidebar || !mainContent) return;
    
    sidebar.classList.toggle('open');
    mainContent.classList.toggle('sidebar-open');
    
    // Change icon based on sidebar state
    if (sidebar.classList.contains('open')) {
        toggleIcon.textContent = '‚úñÔ∏è';
        // Add overlay on mobile
        if (window.innerWidth <= 768) {
            let overlay = document.querySelector('.sidebar-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'sidebar-overlay';
                overlay.onclick = () => toggleSidebar();
                document.body.appendChild(overlay);
            }
        }
    } else {
        toggleIcon.textContent = 'üìã';
        // Remove overlay        
        const overlay = document.querySelector('.sidebar-overlay');
        if (overlay) overlay.remove();
    }
}// Modal dettagli collegamento da sidebar
        function showSidebarCollegamentoModal(id) {
            fetch('/api/collegamenti')
                .then(r => r.json())
                .then(collegamenti => {
                    const c = collegamenti.find(x => x.id === id);
                    if (!c) return;
                    let html = `
                        <div class='mini-collegamento-card'>
                            <div class='collegamento-header'><h4>${c.titolo}</h4></div>
                            <div class='collegamento-argomenti'>
                                <div class='argomento-tag' style='border:2.5px solid ${c.materia1_colore}'>
                                    <a href='/argomento/${c.id_argomento1}'>${c.argomento1_titolo}</a>
                                    <span class='materia-name'>${c.materia1_nome}</span>
                                </div>
                                <div class='collegamento-arrow'>‚ü∑</div>
                                <div class='argomento-tag' style='border:2.5px solid ${c.materia2_colore}'>
                                    <a href='/argomento/${c.id_argomento2}'>${c.argomento2_titolo}</a>
                                    <span class='materia-name'>${c.materia2_nome}</span>
                                </div>
                            </div>
                            <div class='collegamento-footer'>
                                <span class='etichetta-qualita ${c.etichetta_qualita.replace(/ /g,'-').toLowerCase()}'>${c.etichetta_qualita}</span>
                            </div>
                            <div class='collegamento-dettagli' style='margin-top:1em;'>
                                <div class='markdown-content'>${marked.parse(c.dettagli||'')}</div>
                            </div>
                        </div>                    `;
                    document.getElementById('sidebar-collegamento-body').innerHTML = html;
                    document.getElementById('sidebar-collegamento-modal').style.display = 'flex';
                });
        }        function closeSidebarCollegamentoModal() {
            document.getElementById('sidebar-collegamento-modal').style.display = 'none';
        }

        // Helper functions for text highlighting
        function highlightText(text, query) {
            if (!query || !text) return text;
            
            const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
            return text.replace(regex, '<mark class="search-highlight">$1</mark>');
        }
          function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Function to handle editor size controls for add argument form
        function setupAddEditorSizeControls() {
            let isFullscreen = false;
            
            // Get the fullscreen toggle button
            const toggleBtn = document.getElementById('add-fullscreen-toggle');
            const editorSection = document.getElementById('add-markdown-editor-section');
            
            if (!toggleBtn || !editorSection) return;
            
            // Add click handler to toggle button
            toggleBtn.addEventListener('click', function() {
                isFullscreen = !isFullscreen;
                
                // Toggle fullscreen class and active state
                if (isFullscreen) {
                    editorSection.classList.add('editor-large');
                    toggleBtn.classList.add('active');
                    // Add escape key listener
                    addFullscreenEscapeListener();
                } else {
                    editorSection.classList.remove('editor-large');
                    toggleBtn.classList.remove('active');
                    // Remove escape key listener
                    removeFullscreenEscapeListener();
                }
                
                // Refresh CodeMirror if it exists
                refreshAddCodeMirror();
            });
            
            // Function to refresh CodeMirror for add editor
            function refreshAddCodeMirror() {
                const textarea = document.getElementById('contenuto_md_add');
                if (textarea && textarea.nextElementSibling && textarea.nextElementSibling.classList.contains('CodeMirror')) {
                    const cm = textarea.nextElementSibling.CodeMirror;
                    if (cm) {
                        setTimeout(() => {
                            cm.refresh();
                            cm.focus();
                        }, 100);
                    }
                }
            }
            
            // Escape key handler for fullscreen mode
            let escapeHandler = null;
            
            function addFullscreenEscapeListener() {
                escapeHandler = function(e) {
                    if (e.key === 'Escape' && isFullscreen) {
                        // Click the toggle button to exit fullscreen
                        toggleBtn.click();
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            }
            
            function removeFullscreenEscapeListener() {
                if (escapeHandler) {
                    document.removeEventListener('keydown', escapeHandler);
                    escapeHandler = null;
                }
            }
        }
        </script>
    </div> <!-- End main-content --><!-- Sidebar Collegamento Modal -->
    <div id="sidebar-collegamento-modal" class="modal" style="display:none;">
        <div class="modal-content small">
            <div class="modal-header">
                <h3 id="sidebar-collegamento-title">Dettagli Collegamento</h3>
                <button class="modal-close" onclick="closeSidebarCollegamentoModal()">&times;</button>
            </div>
            <div class="modal-body" id="sidebar-collegamento-body">
                <!-- Dettagli caricati dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeSidebarCollegamentoModal()">Chiudi</button>
            </div>
        </div>
    </div>

</body>
</html>
