<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">    <title>{{ argomento.titolo }} - {{ materia.nome }}</title>    <!-- Modular CSS imports -->
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/animations.css">
    <link rel="stylesheet" href="/static/css/buttons.css">
    <link rel="stylesheet" href="/static/css/cards.css">
    <link rel="stylesheet" href="/static/css/modals.css">
    <link rel="stylesheet" href="/static/css/forms.css">
    <link rel="stylesheet" href="/static/css/search.css">
    <link rel="stylesheet" href="/static/css/markdown.css">
    <link rel="stylesheet" href="/static/css/allegati.css">
    <link rel="stylesheet" href="/static/css/context-menu.css">
    <link rel="stylesheet" href="/static/css/responsive.css">
    <link rel="stylesheet" href="/static/css/argomento-page.css"><!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous">
    <!-- Highlight.js CSS - VS Code Dark theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/vs2015.min.css">
      <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>    <!-- CodeMirror for Markdown syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/mode/overlay.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/gfm/gfm.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>
    
    <!-- KaTeX JavaScript -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx" crossorigin="anonymous"></script>
    <!-- KaTeX auto-render extension -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    
    <!-- Highlight.js Core + Popular Languages -->
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/sql.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/php.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/java.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/cpp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/csharp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/go.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/rust.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/kotlin.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/swift.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/ruby.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/perl.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/r.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/matlab.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/shell.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/powershell.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/dockerfile.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/xml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/json.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="breadcrumb">
            <a href="/" class="breadcrumb-link">Materie</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/materia/{{ materia.id }}" class="breadcrumb-link">{{ materia.nome }}</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">{{ argomento.titolo }}</span>
        </div>        <div class="argomento-header-section">
            <div class="argomento-title-container">
                <h1 id="argomento-title" style="color: {{ argomento.colore }}">{{ argomento.titolo }}</h1>
            </div>
            <div class="argomento-label-container">
                <span class="etichetta etichetta-{{ argomento.etichetta_preparazione.replace(' ', '-') }}">
                    {{ argomento.etichetta_preparazione }}
                </span>
            </div>
        </div>
        
        <!-- Action buttons section -->
        <div class="argomento-actions-section">
            <div class="argomento-actions">
                <button id="editBtn" class="action-btn primary-btn">
                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Modifica
                </button>
                <button id="addAllegatoBtn" class="action-btn secondary-btn">
                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Aggiungi allegato
                </button>
                <button id="deleteBtn" class="action-btn danger-btn">
                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="10" y1="11" x2="10" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="14" y1="11" x2="14" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Elimina argomento
                </button>
            </div>
        </div>
    </div>
      <!-- Search in content section -->
    <div class="search-in-content">
        <div class="search-input-wrapper">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="11" cy="11" r="8" stroke="#999" stroke-width="2"/>
                <path d="M21 21l-4.35-4.35" stroke="#999" stroke-width="2"/>
            </svg>
            <input type="text" id="search-in-content" placeholder="Cerca nel contenuto di questo argomento...">
            <div class="search-navigation" id="search-navigation" style="display: none;">
                <span class="search-counter" id="search-counter">0/0</span>
                <button type="button" class="nav-btn nav-prev" id="search-prev" title="Risultato precedente">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
                <button type="button" class="nav-btn nav-next" id="search-next" title="Risultato successivo">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
            </div>
        </div>
        <div id="search-results-summary" class="search-results-summary"></div>
        </div>
    </div>
    
    <!-- Contenuto principale -->
    <div class="argomento-content">
        <!-- Visualizzazione markdown -->
        <div id="markdown-view" class="markdown-content">
            {% if argomento.contenuto_md %}
            <div id="rendered-markdown"></div>
            {% else %}
            <div class="empty-content">
                <p>Nessun contenuto disponibile. <a href="#" id="add-content-link">Aggiungi contenuto</a></p>
            </div>
            {% endif %}
        </div>
        
        <!-- Editor markdown (nascosto di default) -->
        <div id="markdown-editor-section" class="markdown-editor-section" style="display:none;">
            <div class="editor-container">                <div class="markdown-editor">
                    <div class="editor-tabs">
                        <button type="button" class="tab-btn active" data-tab="editor">Editor</button>
                        <button type="button" class="tab-btn" data-tab="preview">Anteprima</button>
                    </div>                    <textarea id="contenuto_md" placeholder="Inserisci il contenuto in formato Markdown...">{{ argomento.contenuto_md or '' }}</textarea>
                    <div id="markdown-preview" class="markdown-preview" style="display:none;"></div>
                </div>
                
                <!-- Sezione modifica etichetta -->
                <div class="etichetta-edit-section">
                    <label for="etichetta_preparazione">Livello di preparazione:</label>
                    <select id="etichetta_preparazione" class="filter-select">
                        <option value="scarsa preparazione" {{ 'selected' if argomento.etichetta_preparazione == 'scarsa preparazione' else '' }}>Scarsa preparazione</option>
                        <option value="media preparazione" {{ 'selected' if argomento.etichetta_preparazione == 'media preparazione' else '' }}>Media preparazione</option>
                        <option value="buona preparazione" {{ 'selected' if argomento.etichetta_preparazione == 'buona preparazione' else '' }}>Buona preparazione</option>
                    </select>
                </div>
                  <!-- Sezione caricamento file -->
                <div class="file-upload-section">
                    <div class="file-input-wrapper">
                        <input type="file" id="file_content" accept=".docx,.pdf,.md" class="file-input-hidden">
                        <div class="file-input-display" id="file_display_editor">
                            <span class="file-icon">üìé</span>
                            <span class="file-text">Scegli file o trascina qui</span>
                            <span class="file-subtext">Clicca per selezionare un file dal tuo computer</span>
                        </div>
                    </div>
                    <div class="file-upload-info">
                        <small>Formati supportati: .docx, .pdf, .md</small>
                    </div>
                    <div id="file-mode-section" class="file-mode-section" style="display:none;">
                        <label>Come inserire il contenuto del file:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="file_mode" value="replace" checked>
                                <span>Sostituisci tutto il contenuto</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="file_mode" value="prepend">
                                <span>Inserisci all'inizio</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="file_mode" value="append">
                                <span>Inserisci alla fine</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Azioni editor -->
                <div class="editor-actions">
                    <button id="saveBtn" class="add-btn">Salva</button>
                    <button id="cancelBtn" class="cancel-btn">Annulla</button>
                </div>
            </div>
        </div>
        
        <!-- Allegati -->
        <div class="allegati-section">
            <h3>Allegati</h3>
            <div id="allegati-list" class="allegati-list">
                {% for allegato in allegati %}
                <div class="allegato-card" data-id="{{ allegato.id }}">
                    <div class="allegato-info">
                        <span class="allegato-nome">{{ allegato.nome_file }}</span>
                        <div class="allegato-actions">
                            <button class="view-allegato-btn" data-path="{{ allegato.percorso }}">Visualizza</button>
                            <button class="delete-allegato-btn" data-id="{{ allegato.id }}">Elimina</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Popup caricamento allegato -->
    <div id="allegatoPopup" class="popup-bg" style="display:none;">
        <div class="popup">
            <h2>Aggiungi allegato</h2>
            <form id="addAllegatoForm" enctype="multipart/form-data">                <div class="form-group">
                    <label for="allegato_file">Seleziona file:</label>
                    <div class="file-input-wrapper">
                        <input type="file" name="file" id="allegato_file" required class="file-input-hidden">
                        <div class="file-input-display" id="file_display_allegato">
                            <span class="file-icon">üìé</span>
                            <span class="file-text">Scegli file o trascina qui</span>
                            <span class="file-subtext">Clicca per selezionare un file dal tuo computer</span>
                        </div>
                    </div>
                </div>
                <div class="popup-actions">
                    <button type="submit" class="add-btn">Carica</button>
                    <button type="button" id="closeAllegatoPopup" class="cancel-btn">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Popup visualizzazione allegato -->
    <div id="viewAllegatoPopup" class="popup-bg" style="display:none;">
        <div class="popup popup-large">
            <h2>Visualizzazione allegato</h2>
            <div id="allegato-content" class="allegato-content">
                <!-- Contenuto dell'allegato verr√† caricato qui -->
            </div>
            <div class="popup-actions">
                <button type="button" id="closeViewAllegatoPopup" class="cancel-btn">Chiudi</button>
            </div>        </div>
    </div>

    <!-- Modal di conferma eliminazione argomento -->
    <div id="confirm-delete-argomento-modal" class="modal" style="display: none;">
        <div class="modal-content">            <h3>Elimina argomento</h3>
            <p>Per eliminare <b>{{ argomento.titolo }}</b>, scrivi il titolo esatto qui sotto e conferma:</p>
            <p><small>Questa azione eliminer√† anche tutti gli allegati associati e non pu√≤ essere annullata.</small></p>
            <input type="text" id="delete-single-argomento-input" placeholder="{{ argomento.titolo }}">
            <div class="modal-buttons">
                <button id="confirm-delete-argomento-btn" class="btn btn-danger">Elimina</button>
                <button id="cancel-delete-argomento-btn" class="btn btn-secondary">Annulla</button>
            </div>
        </div>    </div>

    <script>
        const socket = io();
        const argomentoId = {{ argomento.id }};
        const originalContent = {{ (argomento.contenuto_md or '') | tojson }};
        
        // Inizializzazione della pagina
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize CodeMirror for markdown editing
            let mainEditor;
            let initializationAttempts = 0;
            const maxAttempts = 10;
              function initCodeMirror() {
                const textarea = document.getElementById('contenuto_md');
                
                // Check if CodeMirror is available
                if (typeof CodeMirror === 'undefined') {
                    initializationAttempts++;
                    if (initializationAttempts < maxAttempts) {
                        console.log(`‚è≥ CodeMirror non ancora caricato, tentativo ${initializationAttempts}/${maxAttempts}...`);
                        setTimeout(initCodeMirror, 200); // Increased delay
                        return null;
                    } else {
                        console.error('‚ùå CodeMirror non disponibile dopo', maxAttempts, 'tentativi');
                        console.log('üîÑ Tentativo di caricamento manuale di CodeMirror...');
                        
                        // Try to load CodeMirror manually
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js';
                        script.onload = function() {
                            console.log('‚úÖ CodeMirror caricato manualmente');
                            setTimeout(() => {
                                initializationAttempts = 0; // Reset counter
                                initCodeMirror();
                            }, 100);
                        };
                        script.onerror = function() {
                            console.error('‚ùå Impossibile caricare CodeMirror manualmente');
                            // Fallback to regular textarea
                            if (textarea) {
                                textarea.style.display = 'block';
                                textarea.style.fontFamily = 'Monaco, Menlo, "Ubuntu Mono", monospace';
                                textarea.style.fontSize = '14px';
                                console.log('üí° Fallback: usando textarea normale');
                            }
                        };
                        document.head.appendChild(script);
                        return null;
                    }
                }
                  if (textarea && !mainEditor) {
                    try {
                        console.log('üöÄ Inizializzazione CodeMirror per argomento.html...');
                        
                        // Check if required modes are available
                        const hasGFM = typeof CodeMirror.modes.gfm !== 'undefined';
                        const hasMarkdown = typeof CodeMirror.modes.markdown !== 'undefined';
                        const hasOverlay = typeof CodeMirror.overlayMode !== 'undefined';
                        
                        console.log('üìã Modalit√† disponibili:', { hasGFM, hasMarkdown, hasOverlay });
                        
                        // Choose the best available mode
                        let mode = 'text/plain'; // Fallback
                        if (hasGFM && hasOverlay) {
                            mode = 'gfm';
                        } else if (hasMarkdown) {
                            mode = 'markdown';
                        }
                        
                        console.log('üéØ Modalit√† selezionata:', mode);
                          mainEditor = CodeMirror.fromTextArea(textarea, {
                            mode: mode,
                            theme: 'monokai',
                            lineNumbers: true,
                            lineWrapping: true,
                            autoCloseBrackets: true,
                            matchBrackets: true,
                            styleActiveLine: true,
                            placeholder: 'Inserisci il contenuto in formato Markdown...',
                            extraKeys: {
                                "Ctrl-Space": "autocomplete",
                                "F11": function(cm) {
                                    cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                                },
                                "Esc": function(cm) {
                                    if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
                                }
                            }
                        });
                        
                        // Update textarea when CodeMirror changes
                        mainEditor.on('change', function(cm) {
                            textarea.value = cm.getValue();
                            // Update preview if in preview mode
                            updateMarkdownPreview();
                        });
                        
                        // Refresh CodeMirror when shown (important for display)
                        setTimeout(() => {
                            if (mainEditor) {
                                mainEditor.refresh();
                                console.log('‚úÖ CodeMirror inizializzato con successo per argomento.html');
                            }
                        }, 100);
                        
                    } catch (error) {
                        console.error('‚ùå Errore durante l\'inizializzazione di CodeMirror:', error);
                        // Fallback to regular textarea
                        textarea.style.display = 'block';
                        textarea.style.fontFamily = 'Monaco, Menlo, "Ubuntu Mono", monospace';
                        textarea.style.fontSize = '14px';
                        console.log('üí° Fallback: usando textarea normale');
                    }
                }
                return mainEditor;
            }
            
            // Initialize CodeMirror with retry mechanism
            initCodeMirror();
            
            updateMarkdownView();
            setupEventListeners();
            
            // Check if edit mode should be activated from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('edit') === 'true') {
                toggleEditMode();
                // Remove edit parameter from URL without page reload
                const newUrl = window.location.pathname;
                window.history.replaceState({}, '', newUrl);
            }
        });
          function setupEventListeners() {
            // Gestione modifica argomento
            document.getElementById('editBtn').addEventListener('click', toggleEditMode);
            document.getElementById('add-content-link')?.addEventListener('click', function(e) {
                e.preventDefault();
                toggleEditMode();
            });
            
            // Gestione eliminazione argomento
            document.getElementById('deleteBtn').addEventListener('click', function() {
                document.getElementById('confirm-delete-argomento-modal').style.display = 'flex';
            });
              document.getElementById('confirm-delete-argomento-btn').addEventListener('click', function() {
                const argomentoTitle = '{{ argomento.titolo }}';
                const inputValue = document.getElementById('delete-single-argomento-input').value.trim();
                
                if (inputValue !== argomentoTitle) {
                    alert('Il titolo inserito non corrisponde.');
                    return;
                }
                
                deleteCurrentArgomento();
            });
              document.getElementById('cancel-delete-argomento-btn').addEventListener('click', function() {
                document.getElementById('confirm-delete-argomento-modal').style.display = 'none';
                document.getElementById('delete-single-argomento-input').value = '';
            });
              // Gestione ricerca nel contenuto
            document.getElementById('search-in-content').addEventListener('input', searchInContent);
            
            // Gestione navigazione ricerca
            document.getElementById('search-prev').addEventListener('click', navigateToPrevious);
            document.getElementById('search-next').addEventListener('click', navigateToNext);
            
            // Gestione tasto Enter per navigazione
            document.getElementById('search-in-content').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentSearchMatches.length > 0) {
                        navigateToNext();
                    }
                }
            });
            
            // Gestione salvataggio
            document.getElementById('saveBtn').addEventListener('click', saveArgomento);
            document.getElementById('cancelBtn').addEventListener('click', cancelEdit);
            
            // Gestione allegati
            document.getElementById('addAllegatoBtn').addEventListener('click', function() {
                document.getElementById('allegatoPopup').style.display = 'flex';
            });
            
            document.getElementById('closeAllegatoPopup').addEventListener('click', function() {
                document.getElementById('allegatoPopup').style.display = 'none';
            });
            
            document.getElementById('addAllegatoForm').addEventListener('submit', uploadAllegato);
            
            // Gestione visualizzazione allegati
            document.querySelectorAll('.view-allegato-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    viewAllegato(this.dataset.path);
                });
            });
            
            // Gestione eliminazione allegati
            document.querySelectorAll('.delete-allegato-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('Sei sicuro di voler eliminare questo allegato?')) {
                        deleteAllegato(this.dataset.id);
                    }
                });
            });
            
            document.getElementById('closeViewAllegatoPopup').addEventListener('click', function() {
                document.getElementById('viewAllegatoPopup').style.display = 'none';
            });
            
            // Gestione tabs markdown
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
            
            // Gestione selezione file
            document.getElementById('file_content').addEventListener('change', function() {
                const fileModeSection = document.getElementById('file-mode-section');
                if (this.files.length > 0) {
                    fileModeSection.style.display = 'block';
                } else {
                    fileModeSection.style.display = 'none';
                }
            });
        }
        
        function updateMarkdownPreview() {
            const preview = document.getElementById('markdown-preview');
            if (!preview) return;
            
            // Check if preview is currently visible
            if (preview.style.display !== 'block') return;
            
            // Get content from CodeMirror or textarea
            const textarea = document.getElementById('contenuto_md');
            const codeMirrorWrapper = textarea ? textarea.nextElementSibling : null;
            let content = '';
            
            if (codeMirrorWrapper && codeMirrorWrapper.classList.contains('CodeMirror')) {
                const cm = codeMirrorWrapper.CodeMirror;
                content = cm ? cm.getValue() : textarea.value;
            } else if (textarea) {
                content = textarea.value;
            }
            
            const previewContent = parseMarkdownSafely(content) || '<p>Nessun contenuto da visualizzare</p>';
            preview.innerHTML = previewContent;
        }
        
        function parseMarkdownSafely(content) {
            if (!content || !content.trim()) {
                return '';
            }
            
            console.log('üîç Inizio parsing del contenuto con KaTeX e Highlight.js...');
            
            try {
                // Step 1: Parse markdown content
                const htmlContent = marked.parse(content);
                
                // Step 2: Create temporary container for KaTeX rendering
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                
                // Step 3: Apply syntax highlighting with highlight.js
                console.log('üé® Applicando syntax highlighting...');
                tempDiv.querySelectorAll('pre code').forEach((block) => {
                    // Rimuovi eventuali classi esistenti di highlight.js
                    block.className = block.className.replace(/hljs\S*/g, '');
                    
                    // Applica la syntax highlighting
                    hljs.highlightElement(block);
                    
                    // Aggiungi una classe per lo styling personalizzato
                    block.classList.add('hljs-enhanced');
                });
                
                // Step 4: Render math with KaTeX
                console.log('üßÆ Rendering formule matematiche...');
                renderMathInElement(tempDiv, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "\\[", right: "\\]", display: true},
                        {left: "$", right: "$", display: false},
                        {left: "\\(", right: "\\)", display: false}
                    ],
                    throwOnError: false,
                    errorColor: '#cc0000',
                    strict: false,
                    trust: false,
                    macros: {
                        "\\f": "#1f(#2)"
                    }
                });
                
                console.log('‚úÖ Parser con KaTeX e Highlight.js riuscito');
                return tempDiv.innerHTML;
                
            } catch (error) {
                console.error('‚ùå Errore nel parsing avanzato:', error);
                // Fallback to basic markdown without math but with highlighting
                try {
                    const basicHtml = marked.parse(content);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = basicHtml;
                      // Apply only syntax highlighting in fallback
                    tempDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                        block.classList.add('hljs-enhanced');
                    });
                    
                    return tempDiv.innerHTML;
                } catch (fallbackError) {
                    console.error('‚ùå Anche il fallback √® fallito:', fallbackError);
                    return parseWithBasicFallback(content);
                }
            }
        }
        
        function parseWithForcedCleanup(content) {
            console.log('üßπ Applico pulizia forzata del contenuto...');
            
            try {
                // Pulizia aggressiva della sintassi problematica
                let cleanedContent = content
                    // Sostituisce blocchi math con testo leggibile
                    .replace(/```math\s*\n([\s\S]*?)\n```/gi, function(match, mathContent) {
                        console.log('üîÑ Sostituisco blocco math:', mathContent.substring(0, 50) + '...');
                        return '\n**üìê Formula matematica:**\n```\n' + mathContent.replace(/\\/g, '') + '\n```\n';
                    })
                    // Sostituisce formule LaTeX display
                    .replace(/\$\$\s*([\s\S]*?)\s*\$\$/g, function(match, formula) {
                        console.log('üîÑ Sostituisco formula display:', formula.substring(0, 30) + '...');
                        return '\n**üìê Formula:** `' + formula.replace(/\\/g, '') + '`\n';
                    })
                    // Sostituisce formule LaTeX inline
                    .replace(/\$([^$\n]+)\$/g, function(match, formula) {
                        return '*[' + formula.replace(/\\/g, '') + ']*';
                    });
                
                console.log('üßπ Contenuto pulito, tentativo parsing...');
                const result = marked.parse(cleanedContent);
                console.log('‚úÖ Parsing con contenuto pulito riuscito');
                return result;
                
            } catch (error) {
                console.error('‚ùå Anche il parsing pulito √® fallito:', error);
                // Fallback finale con interfaccia di errore
                return `
                    <div class="markdown-error">
                        <div class="markdown-error-title">
                            ‚ö†Ô∏è Errore di sintassi Markdown
                        </div>
                        <p><strong>Il contenuto contiene sintassi non supportata:</strong></p>
                        <ul>
                            <li>Blocchi <code>\`\`\`math</code> non sono supportati</li>
                            <li>Formule LaTeX (<code>$$...$$</code> o <code>$...$</code>) non sono supportate</li>
                        </ul>
                        <p>Usa la modalit√† modifica per correggere la sintassi.</p>
                        <button class="emergency-edit-btn" onclick="toggleEditMode()" style="background: #e74c3c; color: white; border: none; padding: 0.75em 1.5em; border-radius: 4px; cursor: pointer; font-weight: bold;">
                            üõ†Ô∏è MODIFICA CONTENUTO
                        </button>
                        <details style="margin-top: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">üìÑ Mostra contenuto grezzo</summary>
                            <div class="markdown-error-content">${escapeHtml(content)}</div>
                        </details>
                    </div>
                `;
            }
        }
          function basicMarkdownParser(content) {
            // Parser markdown molto basilare per fallback
            let html = content
                // Gestione blocchi di codice prima
                .replace(/```(\w+)?\s*\n([\s\S]*?)\n```/g, '<pre><code>$2</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Bold e italic
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Blockquotes
                .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
                // Line breaks e paragrafi
                .replace(/\n\n+/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Wrappa in paragrafi se non √® gi√† html strutturato
            if (!html.includes('<h') && !html.includes('<p>')) {
                html = '<p>' + html + '</p>';
            } else if (!html.includes('<p>')) {
                html = '<p>' + html + '</p>';
            }
            
            return html;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }        function updateMarkdownView() {
            // Uso JSON per evitare problemi con backtick e caratteri speciali
            const content = {{ (argomento.contenuto_md or '') | tojson }};
            console.log('üìù Contenuto caricato:', content.substring(0, 100) + '...');
            
            const renderedContent = parseMarkdownSafely(content);
            const markdownElement = document.getElementById('rendered-markdown');
            
            if (!markdownElement) {
                console.error('Elemento rendered-markdown non trovato nel DOM');
                return;
            }
            
            if (renderedContent) {
                markdownElement.innerHTML = renderedContent;
            } else {
                markdownElement.innerHTML = `
                    <div class="empty-content">
                        <p>Nessun contenuto disponibile. <a href="#" id="add-content-link">Aggiungi contenuto</a></p>
                    </div>
                `;
            }
        }
          function toggleEditMode() {
            const viewSection = document.getElementById('markdown-view');
            const editorSection = document.getElementById('markdown-editor-section');
            
            if (editorSection.style.display === 'none') {
                viewSection.style.display = 'none';
                editorSection.style.display = 'block';
                document.getElementById('contenuto_md').focus();
            } else {
                viewSection.style.display = 'block';
                editorSection.style.display = 'none';
            }
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            const tabButton = document.querySelector(`[data-tab="${tab}"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
            
            // Get CodeMirror instance
            const textarea = document.getElementById('contenuto_md');
            const preview = document.getElementById('markdown-preview');
            
            if (!textarea || !preview) {
                console.error('Elementi textarea o preview non trovati nel DOM');
                return;
            }
            
            // Find CodeMirror wrapper
            const codeMirrorWrapper = textarea.nextElementSibling;
            
            if (tab === 'editor') {
                if (codeMirrorWrapper && codeMirrorWrapper.classList.contains('CodeMirror')) {
                    codeMirrorWrapper.style.display = 'block';
                    // Refresh CodeMirror when shown
                    const cm = codeMirrorWrapper.CodeMirror;
                    if (cm) {
                        setTimeout(() => cm.refresh(), 10);
                    }
                } else {
                    textarea.style.display = 'block';
                }
                preview.style.display = 'none';
            } else {
                if (codeMirrorWrapper && codeMirrorWrapper.classList.contains('CodeMirror')) {
                    codeMirrorWrapper.style.display = 'none';
                    // Get content from CodeMirror
                    const cm = codeMirrorWrapper.CodeMirror;
                    const content = cm ? cm.getValue() : textarea.value;
                    const previewContent = parseMarkdownSafely(content) || '<p>Nessun contenuto da visualizzare</p>';
                    preview.innerHTML = previewContent;
                } else {
                    textarea.style.display = 'none';
                    const previewContent = parseMarkdownSafely(textarea.value) || '<p>Nessun contenuto da visualizzare</p>';
                    preview.innerHTML = previewContent;
                }
                preview.style.display = 'block';
            }
        }function saveArgomento() {
            const contenutoElement = document.getElementById('contenuto_md');
            const etichettaElement = document.getElementById('etichetta_preparazione');
            
            if (!contenutoElement || !etichettaElement) {
                console.error('Elementi contenuto_md o etichetta_preparazione non trovati nel DOM');
                return;
            }
            
            const formData = new FormData();
            formData.append('contenuto_md', contenutoElement.value);
            formData.append('etichetta_preparazione', etichettaElement.value);
            
            // Gestione file caricato
            const fileInput = document.getElementById('file_content');
            if (fileInput && fileInput.files.length > 0) {
                formData.append('file_content', fileInput.files[0]);
                const selectedModeElement = document.querySelector('input[name="file_mode"]:checked');
                if (selectedModeElement) {
                    formData.append('file_mode', selectedModeElement.value);
                }
            }
            
            fetch(`/update_argomento/${argomentoId}`, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    location.reload(); // Ricarica la pagina per mostrare le modifiche
                } else {
                    alert('Errore nel salvataggio');
                }
            });
        }
          function cancelEdit() {
            document.getElementById('contenuto_md').value = originalContent;
            document.getElementById('file_content').value = '';
            document.getElementById('file-mode-section').style.display = 'none';
            toggleEditMode();
        }
        
        function uploadAllegato(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch(`/add_allegato/${argomentoId}`, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    document.getElementById('allegatoPopup').style.display = 'none';
                    this.reset();
                } else {
                    alert('Errore nel caricamento del file');
                }
            });
        }
        
        function deleteAllegato(id) {
            fetch(`/delete_allegato/${id}`, {
                method: 'DELETE'
            }).then(response => {
                if (response.ok) {
                    document.querySelector(`[data-id="${id}"]`).remove();
                } else {
                    alert('Errore nell\'eliminazione del file');
                }
            });
        }
        
        function viewAllegato(path) {
            const content = document.getElementById('allegato-content');
            const extension = path.split('.').pop().toLowerCase();
            
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(extension)) {
                content.innerHTML = `<img src="/${path}" style="max-width: 100%; height: auto;">`;
            } else if (['pdf'].includes(extension)) {
                content.innerHTML = `<iframe src="/${path}" style="width: 100%; height: 600px; border: none;"></iframe>`;
            } else if (['txt', 'md'].includes(extension)) {
                fetch(`/${path}`)
                    .then(response => response.text())
                    .then(text => {
                        content.innerHTML = `<pre style="white-space: pre-wrap; padding: 1em; background: #f8f9fa; border-radius: 6px;">${text}</pre>`;
                    });
            } else {
                content.innerHTML = `<p>Tipo di file non supportato per la visualizzazione. <a href="/${path}" download>Scarica file</a></p>`;
            }
            
            document.getElementById('viewAllegatoPopup').style.display = 'flex';
        }
        
        // Aggiornamenti real-time
        socket.on('update_argomento', function(data) {
            if (data.id == argomentoId) {
                location.reload();
            }
        });
        
        socket.on('update_allegati', function(data) {
            if (data.id_argomento == argomentoId) {
                fetch(`/api/allegati/${argomentoId}`)
                    .then(response => response.json())
                    .then(allegati => {
                        const container = document.getElementById('allegati-list');
                        container.innerHTML = '';
                        
                        allegati.forEach(allegato => {
                            const card = document.createElement('div');
                            card.className = 'allegato-card';
                            card.dataset.id = allegato.id;
                            
                            card.innerHTML = `
                                <div class="allegato-info">
                                    <span class="allegato-nome">${allegato.nome_file}</span>
                                    <div class="allegato-actions">
                                        <button class="view-allegato-btn" data-path="${allegato.percorso}">Visualizza</button>
                                        <button class="delete-allegato-btn" data-id="${allegato.id}">Elimina</button>
                                    </div>
                                </div>
                            `;
                            
                            container.appendChild(card);
                        });
                        
                        // Riassegna event listeners
                        setupAllegatoListeners();
                    });
            }
        });
        
        function setupAllegatoListeners() {
            document.querySelectorAll('.view-allegato-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    viewAllegato(this.dataset.path);
                });
            });
            
            document.querySelectorAll('.delete-allegato-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('Sei sicuro di voler eliminare questo allegato?')) {
                        deleteAllegato(this.dataset.id);
                    }
                });
            });
        }
          function parseWithBasicFallback(content) {
            console.log('üîß Usando fallback b√°sico con syntax highlighting...');
            
            // Very basic markdown parsing without math
            let html = content
                // Code blocks - preserve language hints for highlighting
                .replace(/```(\w+)?\s*\n([\s\S]*?)\n```/g, function(match, lang, code) {
                    const langClass = lang ? ` class="language-${lang}"` : '';
                    return `<pre><code${langClass}>${code}</code></pre>`;
                })
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Bold and italic
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Remove math expressions that can't be rendered
                .replace(/\$\$[\s\S]*?\$\$/g, '<span style="background:#ffe6e6;padding:2px 4px;border-radius:3px;">[Formula matematica]</span>')
                .replace(/\$([^$\n]+)\$/g, '<span style="background:#ffe6e6;padding:2px 4px;border-radius:3px;">[Math: $1]</span>')
                // Line breaks
                .replace(/\n\n+/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Wrap in paragraphs
            if (!html.includes('<h') && !html.includes('<p>')) {
                html = '<p>' + html + '</p>';
            }
            
            // Apply syntax highlighting to code blocks
            try {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                tempDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                    block.classList.add('hljs-enhanced');
                });
                
                html = tempDiv.innerHTML;
                console.log('‚úÖ Syntax highlighting applicato al fallback');            } catch (highlightError) {
                console.warn('‚ö†Ô∏è Errore nell\'applicazione del syntax highlighting:', highlightError);
            }
            
            return html;
        }
        
        // Funzione per eliminare l'argomento corrente
        function deleteCurrentArgomento() {
            fetch(`/delete_argomento/${argomentoId}`, {
                method: 'DELETE'
            }).then(response => {
                if (response.ok) {
                    // Redirect alla pagina della materia
                    window.location.href = `/materia/{{ materia.id }}`;
                } else {
                    alert('Errore durante l\'eliminazione dell\'argomento');
                }
            }).catch(error => {
                console.error('Errore:', error);
                alert('Errore durante l\'eliminazione dell\'argomento');
            }).finally(() => {
                document.getElementById('confirm-delete-argomento-modal').style.display = 'none';
            });
        }
          // Variables for search navigation
        let currentSearchMatches = [];
        let currentMatchIndex = -1;
        
        // Funzione per cercare nel contenuto
        function searchInContent() {
            const query = document.getElementById('search-in-content').value.toLowerCase().trim();
            const contentElement = document.getElementById('rendered-markdown');
            const summaryElement = document.getElementById('search-results-summary');
            const navigationElement = document.getElementById('search-navigation');
            const counterElement = document.getElementById('search-counter');
            
            if (!contentElement) return;
            
            if (!query) {
                // Reset highlights and navigation
                resetHighlights();
                summaryElement.style.display = 'none';
                navigationElement.style.display = 'none';
                currentSearchMatches = [];
                currentMatchIndex = -1;
                return;
            }
            
            // Remove existing highlights
            resetHighlights();
            
            // Find and highlight matches
            const matches = highlightTextInElement(contentElement, query);
            
            // Update matches array
            currentSearchMatches = Array.from(contentElement.querySelectorAll('.highlight-match'));
            currentMatchIndex = currentSearchMatches.length > 0 ? 0 : -1;
            
            // Show summary and navigation
            if (matches > 0) {
                summaryElement.innerHTML = `Trovati ${matches} risultati per "${query}"`;
                summaryElement.style.display = 'block';
                
                // Show navigation controls
                navigationElement.style.display = 'flex';
                updateNavigationState();
                
                // Highlight first match and scroll to it
                highlightCurrentMatch();
                scrollToCurrentMatch();
            } else {
                summaryElement.innerHTML = `Nessun risultato trovato per "${query}"`;
                summaryElement.style.display = 'block';
                navigationElement.style.display = 'none';
                currentSearchMatches = [];
                currentMatchIndex = -1;
            }
        }
        
        // Update navigation counter and button states
        function updateNavigationState() {
            const counterElement = document.getElementById('search-counter');
            const prevBtn = document.getElementById('search-prev');
            const nextBtn = document.getElementById('search-next');
            
            if (currentSearchMatches.length === 0) {
                counterElement.textContent = '0/0';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }
            
            counterElement.textContent = `${currentMatchIndex + 1}/${currentSearchMatches.length}`;
            prevBtn.disabled = currentMatchIndex <= 0;
            nextBtn.disabled = currentMatchIndex >= currentSearchMatches.length - 1;
        }
        
        // Highlight current match with special style
        function highlightCurrentMatch() {
            // Remove previous current highlight
            currentSearchMatches.forEach(match => match.classList.remove('current-match'));
            
            // Add current highlight
            if (currentMatchIndex >= 0 && currentMatchIndex < currentSearchMatches.length) {
                currentSearchMatches[currentMatchIndex].classList.add('current-match');
            }
        }
        
        // Scroll to current match
        function scrollToCurrentMatch() {
            if (currentMatchIndex >= 0 && currentMatchIndex < currentSearchMatches.length) {
                const currentMatch = currentSearchMatches[currentMatchIndex];
                currentMatch.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center',
                    inline: 'nearest'
                });
            }
        }
        
        // Navigate to previous match
        function navigateToPrevious() {
            if (currentMatchIndex > 0) {
                currentMatchIndex--;
                updateNavigationState();
                highlightCurrentMatch();
                scrollToCurrentMatch();
            }
        }
        
        // Navigate to next match
        function navigateToNext() {
            if (currentMatchIndex < currentSearchMatches.length - 1) {
                currentMatchIndex++;
                updateNavigationState();
                highlightCurrentMatch();
                scrollToCurrentMatch();
            }
        }
        
        // Funzione per rimuovere gli highlight
        function resetHighlights() {
            const contentElement = document.getElementById('rendered-markdown');
            if (!contentElement) return;
            
            const highlights = contentElement.querySelectorAll('.highlight-match');
            highlights.forEach(highlight => {
                const parent = highlight.parentNode;
                parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
                parent.normalize();
            });
        }
        
        // Funzione per evidenziare il testo
        function highlightTextInElement(element, query) {
            let matchCount = 0;
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                textNodes.push(node);
            }
            
            textNodes.forEach(textNode => {
                const text = textNode.textContent;
                const lowerText = text.toLowerCase();
                const queryIndex = lowerText.indexOf(query);
                
                if (queryIndex !== -1) {
                    const beforeText = text.substring(0, queryIndex);
                    const matchText = text.substring(queryIndex, queryIndex + query.length);
                    const afterText = text.substring(queryIndex + query.length);
                    
                    const fragment = document.createDocumentFragment();
                    
                    if (beforeText) {
                        fragment.appendChild(document.createTextNode(beforeText));
                    }
                    
                    const highlight = document.createElement('span');
                    highlight.className = 'highlight-match';
                    highlight.textContent = matchText;
                    fragment.appendChild(highlight);
                    matchCount++;
                    
                    if (afterText) {
                        fragment.appendChild(document.createTextNode(afterText));
                    }
                    
                    textNode.parentNode.replaceChild(fragment, textNode);
                }
            });
              return matchCount;
        }        // Enhanced file input handling for both file inputs
        document.addEventListener('DOMContentLoaded', function() {
            // Handle editor file input
            const editorFileInput = document.getElementById('file_content');
            const editorFileDisplay = document.getElementById('file_display_editor');
            if (editorFileInput && editorFileDisplay) {
                setupFileInput(editorFileInput, editorFileDisplay);
            }

            // Handle allegato file input
            const allegatoFileInput = document.getElementById('allegato_file');
            const allegatoFileDisplay = document.getElementById('file_display_allegato');
            if (allegatoFileInput && allegatoFileDisplay) {
                setupFileInput(allegatoFileInput, allegatoFileDisplay);
            }
        });

        function setupFileInput(fileInput, fileDisplay) {
            // Make the display area clickable
            fileDisplay.addEventListener('click', function() {
                fileInput.click();
            });

            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                const wrapper = fileInput.closest('.file-input-wrapper');
                
                if (file) {
                    wrapper.classList.add('has-file');
                    fileDisplay.querySelector('.file-icon').textContent = '‚úÖ';
                    fileDisplay.querySelector('.file-text').textContent = `File selezionato: ${file.name}`;
                    fileDisplay.querySelector('.file-subtext').textContent = 'Clicca per cambiare file';
                    fileInput.title = `File selezionato: ${file.name}`;
                } else {
                    wrapper.classList.remove('has-file');
                    fileDisplay.querySelector('.file-icon').textContent = 'üìé';
                    fileDisplay.querySelector('.file-text').textContent = 'Scegli file o trascina qui';
                    fileDisplay.querySelector('.file-subtext').textContent = 'Clicca per selezionare un file dal tuo computer';
                    fileInput.title = '';
                }
            });

            // Drag and drop support
            fileDisplay.addEventListener('dragover', function(e) {
                e.preventDefault();
                fileDisplay.style.borderColor = '#4f8cff';
                fileDisplay.style.backgroundColor = '#f0f4ff';
            });

            fileDisplay.addEventListener('dragleave', function(e) {
                e.preventDefault();
                fileDisplay.style.borderColor = '';
                fileDisplay.style.backgroundColor = '';
            });

            fileDisplay.addEventListener('drop', function(e) {
                e.preventDefault();
                fileDisplay.style.borderColor = '';
                fileDisplay.style.backgroundColor = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });
        }
    </script>
</body>
</html>
