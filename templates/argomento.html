<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>{{ argomento.titolo }} - {{ materia.nome }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="breadcrumb">
            <a href="/" class="breadcrumb-link">Materie</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/materia/{{ materia.id }}" class="breadcrumb-link">{{ materia.nome }}</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">{{ argomento.titolo }}</span>
        </div>
        <div class="argomento-header-section">
            <div class="argomento-title-container">
                <h1 id="argomento-title" style="color: {{ argomento.colore }}">{{ argomento.titolo }}</h1>
                <span class="etichetta etichetta-{{ argomento.etichetta_preparazione.replace(' ', '-') }}">
                    {{ argomento.etichetta_preparazione }}
                </span>
            </div>
            <div class="argomento-actions">
                <button id="editBtn" class="add-btn">Modifica</button>
                <button id="addAllegatoBtn" class="add-btn">Aggiungi allegato</button>
            </div>
        </div>
    </div>
    
    <!-- Contenuto principale -->
    <div class="argomento-content">
        <!-- Visualizzazione markdown -->
        <div id="markdown-view" class="markdown-content">
            {% if argomento.contenuto_md %}
            <div id="rendered-markdown"></div>
            {% else %}
            <div class="empty-content">
                <p>Nessun contenuto disponibile. <a href="#" id="add-content-link">Aggiungi contenuto</a></p>
            </div>
            {% endif %}
        </div>
        
        <!-- Editor markdown (nascosto di default) -->
        <div id="markdown-editor-section" class="markdown-editor-section" style="display:none;">
            <div class="editor-container">                <div class="markdown-editor">
                    <div class="editor-tabs">
                        <button type="button" class="tab-btn active" data-tab="editor">Editor</button>
                        <button type="button" class="tab-btn" data-tab="preview">Anteprima</button>
                    </div>
                    <textarea id="contenuto_md" placeholder="Inserisci il contenuto in formato Markdown...">{{ argomento.contenuto_md or '' }}</textarea>
                    <div id="markdown-preview" class="markdown-preview" style="display:none;"></div>
                </div>
                
                <!-- Sezione caricamento file -->
                <div class="file-upload-section">
                    <input type="file" id="file_content" accept=".docx,.pdf,.md" class="file-input">
                    <div class="file-upload-info">
                        <small>Formati supportati: .docx, .pdf, .md</small>
                    </div>
                    <div id="file-mode-section" class="file-mode-section" style="display:none;">
                        <label>Come inserire il contenuto del file:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="file_mode" value="replace" checked>
                                <span>Sostituisci tutto il contenuto</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="file_mode" value="prepend">
                                <span>Inserisci all'inizio</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="file_mode" value="append">
                                <span>Inserisci alla fine</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Azioni editor -->
                <div class="editor-actions">
                    <button id="saveBtn" class="add-btn">Salva</button>
                    <button id="cancelBtn" class="cancel-btn">Annulla</button>
                </div>
            </div>
        </div>
        
        <!-- Allegati -->
        <div class="allegati-section">
            <h3>Allegati</h3>
            <div id="allegati-list" class="allegati-list">
                {% for allegato in allegati %}
                <div class="allegato-card" data-id="{{ allegato.id }}">
                    <div class="allegato-info">
                        <span class="allegato-nome">{{ allegato.nome_file }}</span>
                        <div class="allegato-actions">
                            <button class="view-allegato-btn" data-path="{{ allegato.percorso }}">Visualizza</button>
                            <button class="delete-allegato-btn" data-id="{{ allegato.id }}">Elimina</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Popup caricamento allegato -->
    <div id="allegatoPopup" class="popup-bg" style="display:none;">
        <div class="popup">
            <h2>Aggiungi allegato</h2>
            <form id="addAllegatoForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="allegato_file">Seleziona file:</label>
                    <input type="file" name="file" id="allegato_file" required class="file-input">
                </div>
                <div class="popup-actions">
                    <button type="submit" class="add-btn">Carica</button>
                    <button type="button" id="closeAllegatoPopup" class="cancel-btn">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Popup visualizzazione allegato -->
    <div id="viewAllegatoPopup" class="popup-bg" style="display:none;">
        <div class="popup popup-large">
            <h2>Visualizzazione allegato</h2>
            <div id="allegato-content" class="allegato-content">
                <!-- Contenuto dell'allegato verrÃ  caricato qui -->
            </div>
            <div class="popup-actions">
                <button type="button" id="closeViewAllegatoPopup" class="cancel-btn">Chiudi</button>
            </div>
        </div>
    </div>

    <script>        const socket = io();
        const argomentoId = {{ argomento.id }};
        const originalContent = {{ (argomento.contenuto_md or '') | tojson }};
        
        // Inizializzazione della pagina
        document.addEventListener('DOMContentLoaded', function() {
            updateMarkdownView();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Gestione modifica argomento
            document.getElementById('editBtn').addEventListener('click', toggleEditMode);
            document.getElementById('add-content-link')?.addEventListener('click', function(e) {
                e.preventDefault();
                toggleEditMode();
            });
            
            // Gestione salvataggio
            document.getElementById('saveBtn').addEventListener('click', saveArgomento);
            document.getElementById('cancelBtn').addEventListener('click', cancelEdit);
            
            // Gestione allegati
            document.getElementById('addAllegatoBtn').addEventListener('click', function() {
                document.getElementById('allegatoPopup').style.display = 'flex';
            });
            
            document.getElementById('closeAllegatoPopup').addEventListener('click', function() {
                document.getElementById('allegatoPopup').style.display = 'none';
            });
            
            document.getElementById('addAllegatoForm').addEventListener('submit', uploadAllegato);
            
            // Gestione visualizzazione allegati
            document.querySelectorAll('.view-allegato-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    viewAllegato(this.dataset.path);
                });
            });
            
            // Gestione eliminazione allegati
            document.querySelectorAll('.delete-allegato-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('Sei sicuro di voler eliminare questo allegato?')) {
                        deleteAllegato(this.dataset.id);
                    }
                });
            });
            
            document.getElementById('closeViewAllegatoPopup').addEventListener('click', function() {
                document.getElementById('viewAllegatoPopup').style.display = 'none';
            });
            
            // Gestione tabs markdown
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
            
            // Gestione selezione file
            document.getElementById('file_content').addEventListener('change', function() {
                const fileModeSection = document.getElementById('file-mode-section');
                if (this.files.length > 0) {
                    fileModeSection.style.display = 'block';
                } else {
                    fileModeSection.style.display = 'none';
                }
            });
        }        function parseMarkdownSafely(content) {
            if (!content || !content.trim()) {
                return '';
            }
            
            console.log('ð Inizio parsing del contenuto...');
            
            // STEP 1: Rilevamento preventivo di sintassi problematica
            const hasProblematicSyntax = 
                content.includes('```math') || 
                /\$\$[\s\S]*?\$\$/g.test(content) ||
                content.includes('\\int') ||
                content.includes('\\sum') ||
                content.includes('\\frac');
            
            if (hasProblematicSyntax) {
                console.warn('â ï¸ RILEVATA SINTASSI PROBLEMATICA - Uso pulizia preventiva');
                return parseWithForcedCleanup(content);
            }
            
            // STEP 2: Tentativo parsing normale
            try {
                const result = marked.parse(content);
                console.log('â Parser normale riuscito');
                return result;
            } catch (error) {
                console.error('â Parser normale fallito:', error);
                return parseWithForcedCleanup(content);
            }
        }
        
        function parseWithForcedCleanup(content) {
            console.log('ð§¹ Applico pulizia forzata del contenuto...');
            
            try {
                // Pulizia aggressiva della sintassi problematica
                let cleanedContent = content
                    // Sostituisce blocchi math con testo leggibile
                    .replace(/```math\s*\n([\s\S]*?)\n```/gi, function(match, mathContent) {
                        console.log('ð Sostituisco blocco math:', mathContent.substring(0, 50) + '...');
                        return '\n**ð Formula matematica:**\n```\n' + mathContent.replace(/\\/g, '') + '\n```\n';
                    })
                    // Sostituisce formule LaTeX display
                    .replace(/\$\$\s*([\s\S]*?)\s*\$\$/g, function(match, formula) {
                        console.log('ð Sostituisco formula display:', formula.substring(0, 30) + '...');
                        return '\n**ð Formula:** `' + formula.replace(/\\/g, '') + '`\n';
                    })
                    // Sostituisce formule LaTeX inline
                    .replace(/\$([^$\n]+)\$/g, function(match, formula) {
                        return '*[' + formula.replace(/\\/g, '') + ']*';
                    });
                
                console.log('ð§¹ Contenuto pulito, tentativo parsing...');
                const result = marked.parse(cleanedContent);
                console.log('â Parsing con contenuto pulito riuscito');
                return result;
                
            } catch (error) {
                console.error('â Anche il parsing pulito Ã¨ fallito:', error);
                // Fallback finale con interfaccia di errore
                return `
                    <div class="markdown-error">
                        <div class="markdown-error-title">
                            â ï¸ Errore di sintassi Markdown
                        </div>
                        <p><strong>Il contenuto contiene sintassi non supportata:</strong></p>
                        <ul>
                            <li>Blocchi <code>\`\`\`math</code> non sono supportati</li>
                            <li>Formule LaTeX (<code>$$...$$</code> o <code>$...$</code>) non sono supportate</li>
                        </ul>
                        <p>Usa la modalitÃ  modifica per correggere la sintassi.</p>
                        <button class="emergency-edit-btn" onclick="toggleEditMode()" style="background: #e74c3c; color: white; border: none; padding: 0.75em 1.5em; border-radius: 4px; cursor: pointer; font-weight: bold;">
                            ð ï¸ MODIFICA CONTENUTO
                        </button>
                        <details style="margin-top: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">ð Mostra contenuto grezzo</summary>
                            <div class="markdown-error-content">${escapeHtml(content)}</div>
                        </details>
                    </div>
                `;
            }
        }
          function basicMarkdownParser(content) {
            // Parser markdown molto basilare per fallback
            let html = content
                // Gestione blocchi di codice prima
                .replace(/```(\w+)?\s*\n([\s\S]*?)\n```/g, '<pre><code>$2</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Bold e italic
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Blockquotes
                .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
                // Line breaks e paragrafi
                .replace(/\n\n+/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Wrappa in paragrafi se non Ã¨ giÃ  html strutturato
            if (!html.includes('<h') && !html.includes('<p>')) {
                html = '<p>' + html + '</p>';
            } else if (!html.includes('<p>')) {
                html = '<p>' + html + '</p>';
            }
            
            return html;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }        function updateMarkdownView() {
            // Uso JSON per evitare problemi con backtick e caratteri speciali
            const content = {{ (argomento.contenuto_md or '') | tojson }};
            console.log('ð Contenuto caricato:', content.substring(0, 100) + '...');
            
            const renderedContent = parseMarkdownSafely(content);
            
            if (renderedContent) {
                document.getElementById('rendered-markdown').innerHTML = renderedContent;
            } else {
                document.getElementById('rendered-markdown').innerHTML = `
                    <div class="empty-content">
                        <p>Nessun contenuto disponibile. <a href="#" id="add-content-link">Aggiungi contenuto</a></p>
                    </div>
                `;
            }
        }
        
        function toggleEditMode() {
            const viewSection = document.getElementById('markdown-view');
            const editorSection = document.getElementById('markdown-editor-section');
            
            if (editorSection.style.display === 'none') {
                viewSection.style.display = 'none';
                editorSection.style.display = 'block';
                document.getElementById('contenuto_md').focus();
            } else {
                viewSection.style.display = 'block';
                editorSection.style.display = 'none';
            }
        }
          function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            const textarea = document.getElementById('contenuto_md');
            const preview = document.getElementById('markdown-preview');
            
            if (tab === 'editor') {
                textarea.style.display = 'block';
                preview.style.display = 'none';
            } else {
                textarea.style.display = 'none';
                preview.style.display = 'block';
                const previewContent = parseMarkdownSafely(textarea.value) || '<p>Nessun contenuto da visualizzare</p>';
                preview.innerHTML = previewContent;
            }
        }
        
        function saveArgomento() {
            const formData = new FormData();
            formData.append('contenuto_md', document.getElementById('contenuto_md').value);
            
            // Gestione file caricato
            const fileInput = document.getElementById('file_content');
            if (fileInput.files.length > 0) {
                formData.append('file_content', fileInput.files[0]);
                const selectedMode = document.querySelector('input[name="file_mode"]:checked').value;
                formData.append('file_mode', selectedMode);
            }
            
            fetch(`/update_argomento/${argomentoId}`, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    location.reload(); // Ricarica la pagina per mostrare le modifiche
                } else {
                    alert('Errore nel salvataggio');
                }
            });
        }
          function cancelEdit() {
            document.getElementById('contenuto_md').value = originalContent;
            document.getElementById('file_content').value = '';
            document.getElementById('file-mode-section').style.display = 'none';
            toggleEditMode();
        }
        
        function uploadAllegato(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch(`/add_allegato/${argomentoId}`, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    document.getElementById('allegatoPopup').style.display = 'none';
                    this.reset();
                } else {
                    alert('Errore nel caricamento del file');
                }
            });
        }
        
        function deleteAllegato(id) {
            fetch(`/delete_allegato/${id}`, {
                method: 'DELETE'
            }).then(response => {
                if (response.ok) {
                    document.querySelector(`[data-id="${id}"]`).remove();
                } else {
                    alert('Errore nell\'eliminazione del file');
                }
            });
        }
        
        function viewAllegato(path) {
            const content = document.getElementById('allegato-content');
            const extension = path.split('.').pop().toLowerCase();
            
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(extension)) {
                content.innerHTML = `<img src="/${path}" style="max-width: 100%; height: auto;">`;
            } else if (['pdf'].includes(extension)) {
                content.innerHTML = `<iframe src="/${path}" style="width: 100%; height: 600px; border: none;"></iframe>`;
            } else if (['txt', 'md'].includes(extension)) {
                fetch(`/${path}`)
                    .then(response => response.text())
                    .then(text => {
                        content.innerHTML = `<pre style="white-space: pre-wrap; padding: 1em; background: #f8f9fa; border-radius: 6px;">${text}</pre>`;
                    });
            } else {
                content.innerHTML = `<p>Tipo di file non supportato per la visualizzazione. <a href="/${path}" download>Scarica file</a></p>`;
            }
            
            document.getElementById('viewAllegatoPopup').style.display = 'flex';
        }
        
        // Aggiornamenti real-time
        socket.on('update_argomento', function(data) {
            if (data.id == argomentoId) {
                location.reload();
            }
        });
        
        socket.on('update_allegati', function(data) {
            if (data.id_argomento == argomentoId) {
                fetch(`/api/allegati/${argomentoId}`)
                    .then(response => response.json())
                    .then(allegati => {
                        const container = document.getElementById('allegati-list');
                        container.innerHTML = '';
                        
                        allegati.forEach(allegato => {
                            const card = document.createElement('div');
                            card.className = 'allegato-card';
                            card.dataset.id = allegato.id;
                            
                            card.innerHTML = `
                                <div class="allegato-info">
                                    <span class="allegato-nome">${allegato.nome_file}</span>
                                    <div class="allegato-actions">
                                        <button class="view-allegato-btn" data-path="${allegato.percorso}">Visualizza</button>
                                        <button class="delete-allegato-btn" data-id="${allegato.id}">Elimina</button>
                                    </div>
                                </div>
                            `;
                            
                            container.appendChild(card);
                        });
                        
                        // Riassegna event listeners
                        setupAllegatoListeners();
                    });
            }
        });
        
        function setupAllegatoListeners() {
            document.querySelectorAll('.view-allegato-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    viewAllegato(this.dataset.path);
                });
            });
            
            document.querySelectorAll('.delete-allegato-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('Sei sicuro di voler eliminare questo allegato?')) {
                        deleteAllegato(this.dataset.id);
                    }
                });
            });
        }
    </script>
</body>
</html>
