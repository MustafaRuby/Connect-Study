<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">    <title>{{ argomento.titolo }} - {{ materia.nome }}</title>    <!-- Modular CSS imports -->
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/animations.css">
    <link rel="stylesheet" href="/static/css/buttons.css">
    <link rel="stylesheet" href="/static/css/cards.css">
    <link rel="stylesheet" href="/static/css/modals.css">
    <link rel="stylesheet" href="/static/css/forms.css">
    <link rel="stylesheet" href="/static/css/search.css">
    <link rel="stylesheet" href="/static/css/markdown.css">
    <link rel="stylesheet" href="/static/css/allegati.css">
    <link rel="stylesheet" href="/static/css/context-menu.css">
    <link rel="stylesheet" href="/static/css/responsive.css">    <link rel="stylesheet" href="/static/css/argomento-page.css">
      <!-- Local libraries CSS -->
    <link rel="stylesheet" href="/static/libs/katex/katex.min.css">
    <link rel="stylesheet" href="/static/libs/highlightjs/vs2015.min.css">
    <link rel="stylesheet" href="/static/libs/codemirror/codemirror.min.css">
    <link rel="stylesheet" href="/static/libs/codemirror/monokai.min.css">
    
    <style>
        /* Highlighting specifico per la modale degli argomenti */
        .argomenti-modal-highlight {
            background: linear-gradient(120deg, #ffeb3b 0%, #ffc107 100%) !important;
            color: #333 !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            font-weight: 600 !important;
            box-shadow: 0 1px 3px rgba(255, 193, 7, 0.5) !important;
            border: 1px solid #ff9800 !important;
        }
        
        /* Assicuriamoci che sia visibile nella modale */
        .modal .argomenti-modal-highlight {
            z-index: 1000 !important;
            position: relative !important;
        }
        
        /* Stili per il filtering degli argomenti nella modale */
        .search-hidden {
            display: none !important;
            visibility: hidden !important;
        }
        
        .search-visible {
            display: block !important;
            visibility: visible !important;
        }
        
        /* Stili per la sezione titolo e colore */
        .titolo-colore-edit-section {
            margin-bottom: 1.8em;
        }
        
        .titolo-colore-edit-section .form-row {
            display: flex;
            gap: 20px;
        }
        
        .titolo-colore-edit-section .form-group {
            margin-bottom: 0;
        }
        
        .titolo-colore-edit-section .form-group:first-child {
            flex: 1;
        }
        
        .titolo-colore-edit-section .form-group:last-child {
            flex: 0 0 150px;
        }
        
        .titolo-colore-edit-section label {
            display: block;
            margin-bottom: 0.7em;
            font-weight: 600;
            color: #2a3a5c;
            font-size: 1.05em;
        }
        
        .titolo-colore-edit-section .form-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 0.95em;
            font-weight: 500;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            min-height: 44px;
            box-sizing: border-box;
            font-family: inherit;
        }
        
        .titolo-colore-edit-section .form-input:focus {
            border-color: #4f8cff;
            box-shadow: 
                0 0 0 3px rgba(79, 140, 255, 0.15),
                0 4px 12px rgba(79, 140, 255, 0.1);
            background: #ffffff;
            transform: translateY(-1px);
        }
        
        .titolo-colore-edit-section .form-input:hover:not(:focus) {
            border-color: #cbd5e0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }
        
        .titolo-colore-edit-section .color-input {
            height: 44px;
            padding: 6px;
            cursor: pointer;
        }
        
        .titolo-colore-edit-section .color-input::-webkit-color-swatch-wrapper {
            padding: 2px;
        }
        
        .titolo-colore-edit-section .color-input::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }
    </style>
    
    <!-- Local libraries JavaScript -->
    <script src="/static/libs/socketio/socket.io.min.js"></script>
    <script src="/static/libs/marked/marked.min.js"></script>
    
    <!-- CodeMirror for Markdown syntax highlighting -->
    <script src="/static/libs/codemirror/codemirror.min.js"></script>
    <script src="/static/libs/codemirror/overlay.min.js"></script>
    <script src="/static/libs/codemirror/xml.min.js"></script>
    <script src="/static/libs/codemirror/markdown.min.js"></script>
    <script src="/static/libs/codemirror/gfm.min.js"></script>
    <script src="/static/libs/codemirror/closebrackets.min.js"></script>
    <script src="/static/libs/codemirror/matchbrackets.min.js"></script>
    <script src="/static/libs/codemirror/active-line.min.js"></script>
    
    <!-- KaTeX JavaScript -->
    <script defer src="/static/libs/katex/katex.min.js"></script>
    <script defer src="/static/libs/katex/auto-render.min.js"></script>
    
    <!-- Highlight.js Core + Popular Languages -->
    <script src="/static/libs/highlightjs/highlight.min.js"></script>
    <script src="/static/libs/highlightjs/sql.min.js"></script>
    <script src="/static/libs/highlightjs/php.min.js"></script>
    <script src="/static/libs/highlightjs/python.min.js"></script>
    <script src="/static/libs/highlightjs/java.min.js"></script>
    <script src="/static/libs/highlightjs/cpp.min.js"></script>
    <script src="/static/libs/highlightjs/csharp.min.js"></script>
    <script src="/static/libs/highlightjs/go.min.js"></script>
    <script src="/static/libs/highlightjs/rust.min.js"></script>
    <script src="/static/libs/highlightjs/kotlin.min.js"></script>
    <script src="/static/libs/highlightjs/swift.min.js"></script>
    <script src="/static/libs/highlightjs/ruby.min.js"></script>
    <script src="/static/libs/highlightjs/perl.min.js"></script>
    <script src="/static/libs/highlightjs/r.min.js"></script>
    <script src="/static/libs/highlightjs/matlab.min.js"></script>    <script src="/static/libs/highlightjs/shell.min.js"></script>
    <script src="/static/libs/highlightjs/powershell.min.js"></script>
    <script src="/static/libs/highlightjs/dockerfile.min.js"></script>
    <script src="/static/libs/highlightjs/yaml.min.js"></script>
    <script src="/static/libs/highlightjs/xml.min.js"></script>
    <script src="/static/libs/highlightjs/json.min.js"></script>
    <script src="/static/libs/highlightjs/math.min.js"></script>
</head>
<body class="argomento-page">
    <!-- Left Sidebar for Connections -->
    <div id="left-sidebar" class="left-sidebar">
        <div class="sidebar-toggle" onclick="toggleSidebar()">
            <span class="toggle-icon">üìã</span>
            <span class="toggle-text">Collegamenti</span>
        </div>
        
        <div class="sidebar-content">            <div class="sidebar-header">
                <h3>Collegamenti</h3>                
                <button class="btn btn-sm btn-primary" onclick="showCollegamentoModalEmpty()" style="margin: 10px;">
                    <img src="/static/icons/link-icon.svg" alt="Collegamenti" class="btn-icon" width="20" height="20" style="filter: brightness(0) invert(1);">
                    Collegamenti
                </button>
            </div>
            
            <div class="sidebar-sections">
                <!-- Materie with their connections -->
                <div id="sidebar-materie" class="sidebar-materia">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Main content wrapper -->
    <div class="main-content">
        <div class="header">
        <div class="breadcrumb">
            <a href="/" class="breadcrumb-link">Materie</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/materia/{{ materia.id }}" class="breadcrumb-link">{{ materia.nome }}</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">{{ argomento.titolo }}</span>
        </div>        <div class="argomento-header-section">
            <div class="argomento-title-container">
                <h1 id="argomento-title" style="color: {{ argomento.colore }}">{{ argomento.titolo }}</h1>
            </div>
            <div class="argomento-label-container">
                <span class="etichetta etichetta-{{ argomento.etichetta_preparazione.replace(' ', '-') }}">
                    {{ argomento.etichetta_preparazione }}
                </span>
            </div>
        </div>
          <!-- Action buttons section -->
        <div class="argomento-actions-section">
            <div class="argomento-actions">
                <button id="editBtn" class="action-btn primary-btn">
                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Modifica
                </button>
                <button id="collegaBtn" class="action-btn secondary-btn">
                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Collega
                </button>
                <button id="addAllegatoBtn" class="action-btn secondary-btn">
                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Aggiungi allegato
                </button>
                <button id="deleteBtn" class="action-btn danger-btn">
                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="10" y1="11" x2="10" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="14" y1="11" x2="14" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Elimina argomento
                </button>
            </div>
        </div>
    </div>
    
    <!-- Wrapper dedicato per la gestione della sidebar -->
    <div class="argomento-wrapper">
        <!-- Search in content section - MOVED INSIDE wrapper -->
        <div class="search-in-content">
            <div class="search-input-wrapper">
                <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="11" cy="11" r="8" stroke="#999" stroke-width="2"/>
                    <path d="M21 21l-4.35-4.35" stroke="#999" stroke-width="2"/>
                </svg>
                <input type="text" id="search-in-content" placeholder="Cerca nel contenuto di questo argomento...">
                <div class="search-navigation" id="search-navigation" style="display: none;">
                    <span class="search-counter" id="search-counter">0/0</span>
                    <button type="button" class="nav-btn nav-prev" id="search-prev" title="Risultato precedente">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>
                    <button type="button" class="nav-btn nav-next" id="search-next" title="Risultato successivo">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="search-results-summary" class="search-results-summary"></div>
        </div>
        
        <div class="argomento-container" id="argomento-container">
            <!-- Contenuto principale -->
            <!-- Visualizzazione markdown -->
            <div id="markdown-view" class="markdown-content">
                {% if argomento.contenuto_md %}
                <div id="rendered-markdown"></div>
                {% else %}
                <div class="empty-content">
                    <p>Nessun contenuto disponibile. <a href="#" id="add-content-link">Aggiungi contenuto</a></p>
                </div>
                {% endif %}
            </div>
        
            <!-- Editor markdown (nascosto di default) -->
            <div id="markdown-editor-section" class="markdown-editor-section" style="display:none;">
                <div class="editor-container">
                    <div class="markdown-editor">
                        <div class="editor-tabs">
                            <button type="button" class="tab-btn active" data-tab="editor">Editor</button>
                            <button type="button" class="tab-btn" data-tab="preview">Anteprima</button>                          <!-- Editor size controls -->
                            <div class="editor-size-controls">
                                <button type="button" class="size-btn" id="fullscreen-toggle" title="Attiva/Disattiva modalit√† fullscreen">
                                    <span class="size-icon">‚õ∂</span>
                                </button>
                            </div>
                        </div>

                        <!-- Sezione modifica titolo e colore -->
                        <div class="titolo-colore-edit-section">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="argomento_titolo">Titolo dell'argomento:</label>
                                    <input type="text" id="argomento_titolo" value="{{ argomento.titolo }}" placeholder="Inserisci il titolo dell'argomento" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label for="argomento_colore">Colore:</label>
                                    <input type="color" id="argomento_colore" value="{{ argomento.colore or '#cccccc' }}" class="form-input color-input">
                                </div>
                            </div>
                        </div>

                        <textarea id="contenuto_md" placeholder="Inserisci il contenuto in formato Markdown...">{{ argomento.contenuto_md or '' }}</textarea>
                        <div id="markdown-preview" class="markdown-preview" style="display:none;"></div>
                    </div>
                    
                    <!-- Sezione modifica etichetta -->
                    <div class="etichetta-edit-section">
                        <label for="etichetta_preparazione">Livello di preparazione:</label>
                        <select id="etichetta_preparazione" class="filter-select">
                            <option value="scarsa preparazione" {{ 'selected' if argomento.etichetta_preparazione == 'scarsa preparazione' else '' }}>Scarsa preparazione</option>
                            <option value="media preparazione" {{ 'selected' if argomento.etichetta_preparazione == 'media preparazione' else '' }}>Media preparazione</option>
                            <option value="buona preparazione" {{ 'selected' if argomento.etichetta_preparazione == 'buona preparazione' else '' }}>Buona preparazione</option>
                        </select>
                    </div>
                    <!-- Sezione caricamento file -->
                    <div class="file-upload-section">
                        <div class="file-input-wrapper">
                            <input type="file" id="file_content" accept=".docx,.pdf,.md" class="file-input-hidden">
                            <div class="file-input-display" id="file_display_editor">
                                <span class="file-icon">üìé</span>
                                <span class="file-text">Scegli file o trascina qui</span>
                                <span class="file-subtext">Clicca per selezionare un file dal tuo computer</span>
                            </div>
                        </div>
                        <div class="file-upload-info">
                            <small>Formati supportati: .docx, .pdf, .md</small>
                        </div>
                        <div id="file-mode-section" class="file-mode-section" style="display:none;">
                            <label>Come inserire il contenuto del file:</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="file_mode" value="replace" checked>
                                    <span>Sostituisci tutto il contenuto</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="file_mode" value="prepend">
                                    <span>Inserisci all'inizio</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="file_mode" value="append">
                                    <span>Inserisci alla fine</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Azioni editor -->
                    <div class="editor-actions">
                        <button id="saveBtn" class="add-btn">Salva</button>
                        <button id="cancelBtn" class="cancel-btn">Annulla</button>
                    </div>
                </div>
            </div>
        
    </div>
    
    <!-- Sezione Allegati - SEPARATA dal contenuto principale -->
    <div class="allegati-section-wrapper">
        <div class="allegati-section">
            <div class="allegati-header">
                <h3>üìé Allegati</h3>
                <span class="allegati-count">{{ allegati|length }} file{% if allegati|length != 1 %}s{% endif %}</span>
            </div>
            <div id="allegati-list" class="allegati-list">
                {% for allegato in allegati %}
                <div class="allegato-card" data-id="{{ allegato.id }}">
                    <div class="allegato-info">
                        <span class="allegato-nome">{{ allegato.nome_file }}</span>
                        <div class="allegato-actions">
                            <button class="view-allegato-btn" data-path="{{ allegato.percorso }}">Visualizza</button>
                            <button class="delete-allegato-btn" data-id="{{ allegato.id }}">Elimina</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if allegati|length == 0 %}
                <div class="no-allegati">
                    <p>Nessun allegato presente. Usa il pulsante "Aggiungi allegato" per caricare file.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    </div>

    <!-- Popup caricamento allegato -->
    <div id="allegatoPopup" class="popup-bg" style="display:none;">
        <div class="popup">
            <h2>Aggiungi allegato</h2>
            <form id="addAllegatoForm" enctype="multipart/form-data">                <div class="form-group">
                    <label for="allegato_file">Seleziona file:</label>
                    <div class="file-input-wrapper">
                        <input type="file" name="file" id="allegato_file" required class="file-input-hidden">
                        <div class="file-input-display" id="file_display_allegato">
                            <span class="file-icon">üìé</span>
                            <span class="file-text">Scegli file o trascina qui</span>
                            <span class="file-subtext">Clicca per selezionare un file dal tuo computer</span>
                        </div>
                    </div>
                </div>
                <div class="popup-actions">
                    <button type="submit" class="add-btn">Carica</button>
                    <button type="button" id="closeAllegatoPopup" class="cancel-btn">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Popup visualizzazione allegato -->
    <div id="viewAllegatoPopup" class="popup-bg" style="display:none;">
        <div class="popup popup-large">
            <h2>Visualizzazione allegato</h2>
            <div id="allegato-content" class="allegato-content">
                <!-- Contenuto dell'allegato verr√† caricato qui -->
            </div>
            <div class="popup-actions">
                <button type="button" id="closeViewAllegatoPopup" class="cancel-btn">Chiudi</button>
            </div>        </div>
    </div>    <!-- Modal di conferma eliminazione argomento -->
    <div id="confirm-delete-argomento-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Elimina argomento</h3>
                <button class="modal-close" onclick="document.getElementById('confirm-delete-argomento-modal').style.display = 'none'">&times;</button>
            </div>
            <div class="modal-body">
                <p>Per eliminare <b>{{ argomento.titolo }}</b>, scrivi il titolo esatto qui sotto e conferma:</p>
                <p><small>Questa azione eliminer√† anche tutti gli allegati associati e non pu√≤ essere annullata.</small></p>
                <input type="text" id="delete-single-argomento-input" placeholder="{{ argomento.titolo }}">
                <div class="modal-buttons">
                    <button id="confirm-delete-argomento-btn" class="btn btn-danger">Elimina</button>
                    <button id="cancel-delete-argomento-btn" class="btn btn-secondary">Annulla</button>
                </div>
            </div>
        </div>
    </div><!-- Modal per creare collegamenti -->
    <div id="collegamento-modal" class="modal" style="display: none;">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>Crea Collegamento</h3>
                <button class="modal-close" onclick="closeCollegamentoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="collegamento-form">
                    <div class="form-group">
                        <label for="collegamento-titolo">Titolo del collegamento:</label>
                        <input type="text" id="collegamento-titolo" name="titolo" required placeholder="Inserisci il titolo del collegamento">
                    </div>
                    <div class="connection-endpoints">
                        <div class="endpoint">
                            <label>Argomento 1:</label>
                            <div class="selected-argomento" id="selected-argomento-1">
                                <span class="materia-badge" style="background-color: {{ materia.colore }}">{{ materia.nome }}</span>
                                <span class="argomento-title">{{ argomento.titolo }}</span>
                                <button type="button" class="cancel-btn" onclick="clearArgomento(1)">&times;</button>
                            </div>
                            <button type="button" class="add-btn" onclick="showMaterieSelector(1)">Cambia argomento</button>
                        </div>
                        <div class="connection-arrow">‚Üî</div>
                        <div class="endpoint">
                            <label>Argomento 2:</label>
                            <div class="selected-argomento" id="selected-argomento-2" style="display: none;">
                                <span class="materia-badge"></span>
                                <span class="argomento-title"></span>
                                <button type="button" class="cancel-btn" onclick="clearArgomento(2)">&times;</button>
                            </div>
                            <div id="no-selection-2" class="no-selection">
                                <span>Nessun argomento selezionato</span>
                            </div>
                            <button type="button" class="add-btn" onclick="showMaterieSelector(2)">Seleziona argomento</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="collegamento-dettagli">Dettagli del collegamento:</label>
                        <textarea id="collegamento-dettagli" name="dettagli" rows="4" placeholder="Spiega come sono collegati questi argomenti..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="collegamento-qualita">Qualit√† del collegamento:</label>
                        <select id="collegamento-qualita" name="etichetta_qualita" required>
                            <option value="">Seleziona qualit√†</option>
                            <option value="collegamento forzato">Collegamento forzato</option>
                            <option value="collegamento media qualit√†">Collegamento media qualit√†</option>
                            <option value="collegamento buona qualit√†">Collegamento buona qualit√†</option>
                            <option value="collegamento alta qualit√†">Collegamento alta qualit√†</option>
                        </select>
                    </div>
                    <div class="popup-actions">
                        <button type="submit" class="add-btn">Salva Collegamento</button>
                        <button type="button" class="cancel-btn" onclick="closeCollegamentoModal()">Annulla</button>
                    </div>
                </form>
            </div>
        </div>
    </div>    <!-- Modal per selezionare materie e argomenti -->
    <div id="materie-selector-modal" class="modal" style="display: none;">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>Seleziona Argomento</h3>
                <button class="modal-close" onclick="closeMaterieSelector()">&times;</button>
            </div>
              <div class="modal-body">
                <div id="materie-list" class="materie-list">
                    <!-- Le materie saranno caricate dinamicamente -->
                </div>
                
                <div id="argomenti-list" class="argomenti-list" style="display: none;">
                    <button class="btn btn-secondary back-btn" onclick="showMaterieList()">‚Üê Torna alle materie</button>
                    
                    <div class="search-container">                        <div class="search-group">
                            <input type="text" id="argomenti-search" placeholder="Cerca nei titoli degli argomenti..." class="search-input">
                        </div>
                        <div class="search-group">
                            <input type="text" id="content-search" placeholder="Cerca nel contenuto degli argomenti..." class="search-input">
                        </div>
                    </div>
                    
                    <div id="argomenti-grid" class="argomenti-grid">
                        <!-- Gli argomenti saranno caricati dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal dettagli collegamento da sidebar -->    <div id="sidebar-collegamento-modal" class="modal" style="display:none;">
      <div class="modal-content small">
        <div class="modal-header">
          <h3 id="sidebar-collegamento-title">Dettagli Collegamento</h3>
          <button class="modal-close" onclick="closeSidebarCollegamentoModal()">&times;</button>
        </div>
        <div class="modal-body" id="sidebar-collegamento-body">
          <!-- Dettagli caricati dinamicamente -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeSidebarCollegamentoModal()">Chiudi</button>
        </div>
      </div>
    </div>

    <script>
        const socket = io();
        const argomentoId = {{ argomento.id }};
        const originalContent = {{ (argomento.contenuto_md or '') | tojson }};
        const originalTitolo = {{ argomento.titolo | tojson }};
        const originalColore = {{ (argomento.colore or '#cccccc') | tojson }};
        
        // Inizializzazione della pagina
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize CodeMirror for markdown editing
            let mainEditor;
            let initializationAttempts = 0;
            const maxAttempts = 10;
              function initCodeMirror() {
                const textarea = document.getElementById('contenuto_md');
                
                // Check if CodeMirror is available
                if (typeof CodeMirror === 'undefined') {
                    initializationAttempts++;
                    if (initializationAttempts < maxAttempts) {
                        console.log(`‚è≥ CodeMirror non ancora caricato, tentativo ${initializationAttempts}/${maxAttempts}...`);
                        setTimeout(initCodeMirror, 200); // Increased delay
                        return null;
                    } else {
                        console.error('‚ùå CodeMirror non disponibile dopo', maxAttempts, 'tentativi');
                        console.log('üîÑ Tentativo di caricamento manuale di CodeMirror...');
                        
                        // Try to load CodeMirror manually
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js';
                        script.onload = function() {
                            console.log('‚úÖ CodeMirror caricato manualmente');
                            setTimeout(() => {
                                initializationAttempts = 0; // Reset counter
                                initCodeMirror();
                            }, 100);
                        };
                        script.onerror = function() {
                            console.error('‚ùå Impossibile caricare CodeMirror manualmente');
                            // Fallback to regular textarea
                            if (textarea) {
                                textarea.style.display = 'block';
                                textarea.style.fontFamily = 'Monaco, Menlo, "Ubuntu Mono", monospace';
                                textarea.style.fontSize = '14px';
                                console.log('üí° Fallback: usando textarea normale');
                            }
                        };
                        document.head.appendChild(script);
                        return null;
                    }
                }
                  if (textarea && !mainEditor) {
                    try {
                        console.log('üöÄ Inizializzazione CodeMirror per argomento.html...');
                        
                        // Check if required modes are available
                        const hasGFM = typeof CodeMirror.modes.gfm !== 'undefined';
                        const hasMarkdown = typeof CodeMirror.modes.markdown !== 'undefined';
                        const hasOverlay = typeof CodeMirror.overlayMode !== 'undefined';
                        
                        console.log('üìã Modalit√† disponibili:', { hasGFM, hasMarkdown, hasOverlay });
                        
                        // Choose the best available mode
                        let mode = 'text/plain'; // Fallback
                        if (hasGFM && hasOverlay) {
                            mode = 'gfm';
                        } else if (hasMarkdown) {
                            mode = 'markdown';
                        }
                        
                        console.log('üéØ Modalit√† selezionata:', mode);
                          mainEditor = CodeMirror.fromTextArea(textarea, {
                            mode: mode,
                            theme: 'monokai',
                            lineNumbers: true,
                            lineWrapping: true,
                            autoCloseBrackets: true,
                            matchBrackets: true,
                            styleActiveLine: true,
                            placeholder: 'Inserisci il contenuto in formato Markdown...',
                            extraKeys: {
                                "Ctrl-Space": "autocomplete",
                                "F11": function(cm) {
                                    cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                                },
                                "Esc": function(cm) {
                                    if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
                                }
                            }
                        });
                        
                        // Update textarea when CodeMirror changes
                        mainEditor.on('change', function(cm) {
                            textarea.value = cm.getValue();
                            // Update preview if in preview mode
                            updateMarkdownPreview();
                        });
                        
                        // Refresh CodeMirror when shown (important for display)
                        setTimeout(() => {
                            if (mainEditor) {
                                mainEditor.refresh();
                                console.log('‚úÖ CodeMirror inizializzato con successo per argomento.html');
                            }
                        }, 100);
                        
                    } catch (error) {
                        console.error('‚ùå Errore durante l\'inizializzazione di CodeMirror:', error);
                        // Fallback to regular textarea
                        textarea.style.display = 'block';
                        textarea.style.fontFamily = 'Monaco, Menlo, "Ubuntu Mono", monospace';
                        textarea.style.fontSize = '14px';
                        console.log('üí° Fallback: usando textarea normale');
                    }
                }
                return mainEditor;
            }            // Initialize CodeMirror with retry mechanism
            initCodeMirror();
              updateMarkdownView();
            setupEventListeners();
            setupEditorSizeControls();
            
            // Check if edit mode should be activated from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('edit') === 'true') {
                toggleEditMode();
                // Remove edit parameter from URL without page reload
                const newUrl = window.location.pathname;
                window.history.replaceState({}, '', newUrl);
            }
        });
          function setupEventListeners() {
            // Gestione modifica argomento
            document.getElementById('editBtn').addEventListener('click', toggleEditMode);
            document.getElementById('add-content-link')?.addEventListener('click', function(e) {
                e.preventDefault();
                toggleEditMode();
            });
            
            // Gestione eliminazione argomento
            document.getElementById('deleteBtn').addEventListener('click', function() {
                document.getElementById('confirm-delete-argomento-modal').style.display = 'flex';
            });
              document.getElementById('confirm-delete-argomento-btn').addEventListener('click', function() {
                const argomentoTitle = '{{ argomento.titolo }}';
                const inputValue = document.getElementById('delete-single-argomento-input').value.trim();
                
                if (inputValue !== argomentoTitle) {
                    alert('Il titolo inserito non corrisponde.');
                    return;
                }
                
                deleteCurrentArgomento();
            });
              document.getElementById('cancel-delete-argomento-btn').addEventListener('click', function() {
                document.getElementById('confirm-delete-argomento-modal').style.display = 'none';
                document.getElementById('delete-single-argomento-input').value = '';
            });
              // Gestione ricerca nel contenuto
            document.getElementById('search-in-content').addEventListener('input', searchInContent);
            
            // Gestione navigazione ricerca
            document.getElementById('search-prev').addEventListener('click', navigateToPrevious);
            document.getElementById('search-next').addEventListener('click', navigateToNext);            // Gestione tasto Enter per navigazione
            document.getElementById('search-in-content').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentSearchMatches.length > 0) {
                        navigateToNext();
                    }
                }
            });
            
            // Gestione salvataggio
            document.getElementById('saveBtn').addEventListener('click', saveArgomento);
            document.getElementById('cancelBtn').addEventListener('click', cancelEdit);
              // Gestione allegati
            document.getElementById('addAllegatoBtn').addEventListener('click', function() {
                document.getElementById('allegatoPopup').style.display = 'flex';
            });
            
            // Gestione collegamenti
            document.getElementById('collegaBtn').addEventListener('click', function() {
                showCollegamentoModal({{ argomento.id }});
            });
            
            document.getElementById('closeAllegatoPopup').addEventListener('click', function() {
                document.getElementById('allegatoPopup').style.display = 'none';
            });
            
            document.getElementById('addAllegatoForm').addEventListener('submit', uploadAllegato);
            
            // Gestione visualizzazione allegati
            document.querySelectorAll('.view-allegato-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    viewAllegato(this.dataset.path);
                });
            });
            
            // Gestione eliminazione allegati
            document.querySelectorAll('.delete-allegato-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('Sei sicuro di voler eliminare questo allegato?')) {
                        deleteAllegato(this.dataset.id);
                    }
                });
            });
            
            document.getElementById('closeViewAllegatoPopup').addEventListener('click', function() {
                document.getElementById('viewAllegatoPopup').style.display = 'none';
            });
            
            // Gestione tabs markdown
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
              // Gestione selezione file
            document.getElementById('file_content').addEventListener('change', function() {
                const fileModeSection = document.getElementById('file-mode-section');
                if (this.files.length > 0) {
                    fileModeSection.style.display = 'block';
                } else {
                    fileModeSection.style.display = 'none';
                }
            });            // Gestione collegamenti
            document.getElementById('collegaBtn').addEventListener('click', function() {
                showCollegamentoModal({{ argomento.id }});
            });
            
            // Initialize argomenti modal search functionality
            setupArgomentiModalSearch();
        }
        
        function updateMarkdownPreview() {
            const preview = document.getElementById('markdown-preview');
            if (!preview) return;
            
            // Check if preview is currently visible
            if (preview.style.display !== 'block') return;
            
            // Get content from CodeMirror or textarea
            const textarea = document.getElementById('contenuto_md');
            const codeMirrorWrapper = textarea ? textarea.nextElementSibling : null;
            let content = '';
            
            if (codeMirrorWrapper && codeMirrorWrapper.classList.contains('CodeMirror')) {
                const cm = codeMirrorWrapper.CodeMirror;
                content = cm ? cm.getValue() : textarea.value;
            } else if (textarea) {
                content = textarea.value;
            }
            
            const previewContent = parseMarkdownSafely(content) || '<p>Nessun contenuto da visualizzare</p>';
            preview.innerHTML = previewContent;
        }
        
        function parseMarkdownSafely(content) {
            if (!content || !content.trim()) {
                return '';
            }
            
            console.log('üîç Inizio parsing del contenuto con KaTeX e Highlight.js...');
            
            try {
                // Step 1: Parse markdown content
                const htmlContent = marked.parse(content);
                
                // Step 2: Create temporary container for KaTeX rendering
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;                // Step 3: Apply syntax highlighting with highlight.js
                console.log('üé® Applicando syntax highlighting...');
                tempDiv.querySelectorAll('pre code').forEach((block) => {
                    // Rimuovi eventuali classi esistenti di highlight.js
                    block.className = block.className.replace(/hljs\S*/g, '');
                    
                    // Applica la syntax highlighting solo per linguaggi supportati
                    try {
                        hljs.highlightElement(block);
                        // Aggiungi una classe per lo styling personalizzato
                        block.classList.add('hljs-enhanced');
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Could not highlight code block:', error);
                    }
                });
                
                // Step 4: Render math with KaTeX
                console.log('üßÆ Rendering formule matematiche...');
                renderMathInElement(tempDiv, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "\\[", right: "\\]", display: true},
                        {left: "$", right: "$", display: false},
                        {left: "\\(", right: "\\)", display: false}
                    ],
                    throwOnError: false,
                    errorColor: '#cc0000',
                    strict: false,
                    trust: false,
                    macros: {
                        "\\f": "#1f(#2)"
                    }
                });
                
                console.log('‚úÖ Parser con KaTeX e Highlight.js riuscito');
                return tempDiv.innerHTML;
                
            } catch (error) {
                console.error('‚ùå Errore nel parsing avanzato:', error);
                // Fallback to basic markdown without math but with highlighting
                try {
                    const basicHtml = marked.parse(content);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = basicHtml;
                      // Apply only syntax highlighting in fallback
                    tempDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                        block.classList.add('hljs-enhanced');
                    });
                    
                    return tempDiv.innerHTML;
                } catch (fallbackError) {
                    console.error('‚ùå Anche il fallback √® fallito:', fallbackError);
                    return parseWithBasicFallback(content);
                }
            }
        }
        
        function parseWithForcedCleanup(content) {
            console.log('üßπ Applico pulizia forzata del contenuto...');
            
            try {
                // Pulizia aggressiva della sintassi problematica
                let cleanedContent = content
                    // Sostituisce blocchi math con testo leggibile
                    .replace(/```math\s*\n([\s\S]*?)\n```/gi, function(match, mathContent) {
                        console.log('üîÑ Sostituisco blocco math:', mathContent.substring(0, 50) + '...');
                        return '\n**üìê Formula matematica:**\n```\n' + mathContent.replace(/\\/g, '') + '\n```\n';
                    })
                    // Sostituisce formule LaTeX display
                    .replace(/\$\$\s*([\s\S]*?)\s*\$\$/g, function(match, formula) {
                        console.log('üîÑ Sostituisco formula display:', formula.substring(0, 30) + '...');
                        return '\n**üìê Formula:** `' + formula.replace(/\\/g, '') + '`\n';
                    })
                    // Sostituisce formule LaTeX inline
                    .replace(/\$([^$\n]+)\$/g, function(match, formula) {
                        return '*[' + formula.replace(/\\/g, '') + ']*';
                    });
                
                console.log('üßπ Contenuto pulito, tentativo parsing...');
                const result = marked.parse(cleanedContent);
                console.log('‚úÖ Parsing con contenuto pulito riuscito');
                return result;
                
            } catch (error) {
                console.error('‚ùå Anche il parsing pulito √® fallito:', error);
                // Fallback finale con interfaccia di errore
                return `
                    <div class="markdown-error">
                        <div class="markdown-error-title">
                            ‚ö†Ô∏è Errore di sintassi Markdown
                        </div>
                        <p><strong>Il contenuto contiene sintassi non supportata:</strong></p>
                        <ul>
                            <li>Blocchi <code>\`\`\`math</code> non sono supportati</li>
                            <li>Formule LaTeX (<code>$$...$$</code> o <code>$...$</code>) non sono supportate</li>
                        </ul>
                        <p>Usa la modalit√† modifica per correggere la sintassi.</p>
                        <button class="emergency-edit-btn" onclick="toggleEditMode()" style="background: #e74c3c; color: white; border: none; padding: 0.75em 1.5em; border-radius: 4px; cursor: pointer; font-weight: bold;">
                            üõ†Ô∏è MODIFICA CONTENUTO
                        </button>
                        <details style="margin-top: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">üìÑ Mostra contenuto grezzo</summary>
                            <div class="markdown-error-content">${escapeHtml(content)}</div>
                        </details>
                    </div>
                `;
            }
        }
          function basicMarkdownParser(content) {
            // Parser markdown molto basilare per fallback
            let html = content
                // Gestione blocchi di codice prima
                .replace(/```(\w+)?\s*\n([\s\S]*?)\n```/g, '<pre><code>$2</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Bold e italic
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Blockquotes
                .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
                // Line breaks e paragrafi
                .replace(/\n\n+/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Wrappa in paragrafi se non √® gi√† html strutturato
            if (!html.includes('<h') && !html.includes('<p>')) {
                html = '<p>' + html + '</p>';
            } else if (!html.includes('<p>')) {
                html = '<p>' + html + '</p>';
            }
            
            return html;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }        
        
        function updateMarkdownView() {
            // Uso JSON per evitare problemi con backtick e caratteri speciali
            const content = {{ (argomento.contenuto_md or '') | tojson }};
            console.log('üìù Contenuto caricato:', content ? content.substring(0, 100) + '...' : 'NESSUN CONTENUTO');
            
            const markdownElement = document.getElementById('rendered-markdown');
            
            if (!markdownElement) {
                console.error('‚ùå Elemento rendered-markdown non trovato nel DOM');
                return;
            }
            
            // Verifica che le librerie siano caricate
            if (typeof marked === 'undefined') {
                console.error('‚ùå Libreria marked non caricata');
                markdownElement.innerHTML = '<div class="error">Errore: Libreria markdown non caricata</div>';
                return;
            }
            
            if (!content || !content.trim()) {
                console.log('‚ö†Ô∏è Nessun contenuto da renderizzare');
                markdownElement.innerHTML = `
                    <div class="empty-content">
                        <p>Nessun contenuto disponibile. <a href="#" id="add-content-link">Aggiungi contenuto</a></p>
                    </div>
                `;
                return;
            }
            
            const renderedContent = parseMarkdownSafely(content);
              if (renderedContent) {
                console.log('‚úÖ Contenuto renderizzato con successo');
                markdownElement.innerHTML = renderedContent;
            } else {
                console.error('‚ùå Errore nel rendering del contenuto');
                markdownElement.innerHTML = `
                    <div class="empty-content">
                        <p>Errore nel rendering del contenuto. <a href="#" id="add-content-link">Aggiungi contenuto</a></p>
                    </div>
                `;
            }
            
            // Riattiva i listener per i nuovi elementi
            setupContentLinks();
        }
        
        function setupContentLinks() {
            // Setup add content link
            const addContentLink = document.getElementById('add-content-link');
            if (addContentLink) {
                addContentLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    toggleEditMode();
                });
            }
        }
            
        
          function toggleEditMode() {
            const viewSection = document.getElementById('markdown-view');
            const editorSection = document.getElementById('markdown-editor-section');
            
            if (editorSection.style.display === 'none') {
                viewSection.style.display = 'none';
                editorSection.style.display = 'block';
                document.getElementById('contenuto_md').focus();
            } else {
                viewSection.style.display = 'block';
                editorSection.style.display = 'none';
            }
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            const tabButton = document.querySelector(`[data-tab="${tab}"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
            
            // Get CodeMirror instance
            const textarea = document.getElementById('contenuto_md');
            const preview = document.getElementById('markdown-preview');
            
            if (!textarea || !preview) {
                console.error('Elementi textarea o preview non trovati nel DOM');
                return;
            }
            
            // Find CodeMirror wrapper
            const codeMirrorWrapper = textarea.nextElementSibling;
            
            if (tab === 'editor') {
                if (codeMirrorWrapper && codeMirrorWrapper.classList.contains('CodeMirror')) {
                    codeMirrorWrapper.style.display = 'block';
                    // Refresh CodeMirror when shown
                    const cm = codeMirrorWrapper.CodeMirror;
                    if (cm) {
                        setTimeout(() => cm.refresh(), 10);
                    }
                } else {
                    textarea.style.display = 'block';
                }
                preview.style.display = 'none';
            } else {
                if (codeMirrorWrapper && codeMirrorWrapper.classList.contains('CodeMirror')) {
                    codeMirrorWrapper.style.display = 'none';
                    // Get content from CodeMirror
                    const cm = codeMirrorWrapper.CodeMirror;
                    const content = cm ? cm.getValue() : textarea.value;
                    const previewContent = parseMarkdownSafely(content) || '<p>Nessun contenuto da visualizzare</p>';
                    preview.innerHTML = previewContent;
                } else {
                    textarea.style.display = 'none';                    const previewContent = parseMarkdownSafely(textarea.value) || '<p>Nessun contenuto da visualizzare</p>';
                    preview.innerHTML = previewContent;
                }
                preview.style.display = 'block';
            }
        }

        function saveArgomento() {
            const contenutoElement = document.getElementById('contenuto_md');
            const etichettaElement = document.getElementById('etichetta_preparazione');
            const titoloElement = document.getElementById('argomento_titolo');
            const coloreElement = document.getElementById('argomento_colore');
            
            if (!contenutoElement || !etichettaElement || !titoloElement || !coloreElement) {
                console.error('Elementi del form non trovati nel DOM');
                return;
            }
            
            const formData = new FormData();
            formData.append('contenuto_md', contenutoElement.value);
            formData.append('etichetta_preparazione', etichettaElement.value);
            formData.append('titolo', titoloElement.value);
            formData.append('colore', coloreElement.value);
            
            // Gestione file caricato
            const fileInput = document.getElementById('file_content');
            if (fileInput && fileInput.files.length > 0) {
                formData.append('file_content', fileInput.files[0]);
                const selectedModeElement = document.querySelector('input[name="file_mode"]:checked');
                if (selectedModeElement) {
                    formData.append('file_mode', selectedModeElement.value);
                }
            }
              fetch(`/update_argomento/${argomentoId}`, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    location.reload(); // Ricarica la pagina per mostrare le modifiche
                } else {
                    alert('Errore nel salvataggio');
                }
            }).catch(error => {
                console.error('Errore durante il salvataggio:', error);
                alert('Errore nel salvataggio');
            });
        }
        
        function cancelEdit() {
            document.getElementById('contenuto_md').value = originalContent;
            document.getElementById('argomento_titolo').value = originalTitolo;
            document.getElementById('argomento_colore').value = originalColore;
            document.getElementById('file_content').value = '';
            document.getElementById('file-mode-section').style.display = 'none';
            toggleEditMode();
        }
        
        function uploadAllegato(e) {
            e.preventDefault();
            const formData = new FormData(this);
              fetch(`/add_allegato/${argomentoId}`, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    document.getElementById('allegatoPopup').style.display = 'none';
                    this.reset();
                    // Aggiorna dinamicamente la lista degli allegati
                    updateAllegatiList();
                } else {
                    alert('Errore nel caricamento del file');
                }
            }).catch(error => {
                console.error('Errore nel caricamento allegato:', error);
                alert('Errore nel caricamento del file');
            });
        }
        
        function deleteAllegato(id) {
            fetch(`/delete_allegato/${id}`, {
                method: 'DELETE'
            }).then(response => {
                if (response.ok) {
                    // Rimuove l'elemento dalla lista
                    const allegatoCard = document.querySelector(`[data-id="${id}"]`);
                    if (allegatoCard) {
                        allegatoCard.remove();
                    }
                    // Aggiorna dinamicamente il counter e il fallback
                    updateAllegatiCounter();
                    checkAndShowEmptyState();
                } else {
                    alert('Errore nell\'eliminazione del file');
                }
            }).catch(error => {
                console.error('Errore nell\'eliminazione allegato:', error);
                alert('Errore nell\'eliminazione del file');
            });
        }
        
        function viewAllegato(path) {
            const content = document.getElementById('allegato-content');
            const extension = path.split('.').pop().toLowerCase();
            
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(extension)) {
                content.innerHTML = `<img src="/${path}" style="max-width: 100%; height: auto;">`;
            } else if (['pdf'].includes(extension)) {
                content.innerHTML = `<iframe src="/${path}" style="width: 100%; height: 600px; border: none;"></iframe>`;
            } else if (['txt', 'md'].includes(extension)) {
                fetch(`/${path}`)
                    .then(response => response.text())
                    .then(text => {
                        content.innerHTML = `<pre style="white-space: pre-wrap; padding: 1em; background: #f8f9fa; border-radius: 6px;">${text}</pre>`;
                    });
            } else {
                content.innerHTML = `<p>Tipo di file non supportato per la visualizzazione. <a href="/${path}" download>Scarica file</a></p>`;
            }
            
            document.getElementById('viewAllegatoPopup').style.display = 'flex';
        }
        
        // Aggiornamenti real-time
        socket.on('update_argomento', function(data) {
            if (data.id == argomentoId) {
                location.reload();
            }
        });
        
        socket.on('update_allegati', function(data) {
            if (data.id_argomento == argomentoId) {
                // Utilizza la funzione helper per aggiornare la lista
                updateAllegatiList();
            }
        });
        
        function setupAllegatoListeners() {
            document.querySelectorAll('.view-allegato-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    viewAllegato(this.dataset.path);
                });
            });
            
            document.querySelectorAll('.delete-allegato-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('Sei sicuro di voler eliminare questo allegato?')) {
                        deleteAllegato(this.dataset.id);
                    }
                });
            });
        }
        
        // Funzioni helper per gestione dinamica allegati
        function updateAllegatiList() {
            fetch(`/api/allegati/${argomentoId}`)
                .then(response => response.json())
                .then(allegati => {
                    const allegatoList = document.getElementById('allegati-list');
                    if (!allegatoList) return;
                    
                    // Pulisce la lista corrente
                    allegatoList.innerHTML = '';
                    
                    if (allegati.length === 0) {
                        // Mostra stato vuoto
                        allegatoList.innerHTML = `
                            <div class="no-allegati">
                                <p>Nessun allegato presente. Usa il pulsante "Aggiungi allegato" per caricare file.</p>
                            </div>
                        `;
                    } else {
                        // Aggiunge tutti gli allegati
                        allegati.forEach(allegato => {
                            const allegatoCard = document.createElement('div');
                            allegatoCard.className = 'allegato-card';
                            allegatoCard.setAttribute('data-id', allegato.id);
                            allegatoCard.innerHTML = `
                                <div class="allegato-info">
                                    <span class="allegato-nome">${allegato.nome_file}</span>
                                    <div class="allegato-actions">
                                        <button class="view-allegato-btn" data-path="${allegato.percorso}">Visualizza</button>
                                        <button class="delete-allegato-btn" data-id="${allegato.id}">Elimina</button>
                                    </div>
                                </div>
                            `;
                            allegatoList.appendChild(allegatoCard);
                        });
                        
                        // Riassegna event listeners
                        setupAllegatoListeners();
                    }
                    
                    // Aggiorna il counter
                    updateAllegatiCounter(allegati.length);
                })
                .catch(error => {
                    console.error('Errore nel caricamento allegati:', error);
                });
        }
        
        function updateAllegatiCounter(count) {
            const counterElement = document.querySelector('.allegati-count');
            if (counterElement) {
                if (count === undefined) {
                    // Conta elementi esistenti se count non √® fornito
                    count = document.querySelectorAll('#allegati-list .allegato-card').length;
                }
                
                const fileText = count === 1 ? 'file' : 'files';
                counterElement.textContent = `${count} ${fileText}`;
            }
        }
        
        function checkAndShowEmptyState() {
            const allegatoList = document.getElementById('allegati-list');
            const allegatoCards = allegatoList.querySelectorAll('.allegato-card');
            
            if (allegatoCards.length === 0) {
                // Rimuove eventuali stati vuoti esistenti
                const existingEmpty = allegatoList.querySelector('.no-allegati');
                if (existingEmpty) {
                    existingEmpty.remove();
                }
                
                // Aggiunge nuovo stato vuoto
                const noAllegatiDiv = document.createElement('div');
                noAllegatiDiv.className = 'no-allegati';
                noAllegatiDiv.innerHTML = '<p>Nessun allegato presente. Usa il pulsante "Aggiungi allegato" per caricare file.</p>';
                allegatoList.appendChild(noAllegatiDiv);
            }
        }
          function parseWithBasicFallback(content) {
            console.log('üîß Usando fallback b√°sico con syntax highlighting...');
            
            // Very basic markdown parsing without math
            let html = content
                // Code blocks - preserve language hints for highlighting
                .replace(/```(\w+)?\s*\n([\s\S]*?)\n```/g, function(match, lang, code) {
                    const langClass = lang ? ` class="language-${lang}"` : '';
                    return `<pre><code${langClass}>${code}</code></pre>`;
                })
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Bold and italic
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Remove math expressions that can't be rendered
                .replace(/\$\$[\s\S]*?\$\$/g, '<span style="background:#ffe6e6;padding:2px 4px;border-radius:3px;">[Formula matematica]</span>')
                .replace(/\$([^$\n]+)\$/g, '<span style="background:#ffe6e6;padding:2px 4px;border-radius:3px;">[Math: $1]</span>')
                // Line breaks
                .replace(/\n\n+/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Wrap in paragraphs
            if (!html.includes('<h') && !html.includes('<p>')) {
                html = '<p>' + html + '</p>';
            }
            
            // Apply syntax highlighting to code blocks
            try {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                tempDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                    block.classList.add('hljs-enhanced');
                });
                
                html = tempDiv.innerHTML;
                console.log('‚úÖ Syntax highlighting applicato al fallback');            } catch (highlightError) {
                console.warn('‚ö†Ô∏è Errore nell\'applicazione del syntax highlighting:', highlightError);
            }
            
            return html;
        }
        
        // Funzione per eliminare l'argomento corrente
        function deleteCurrentArgomento() {
            fetch(`/delete_argomento/${argomentoId}`, {
                method: 'DELETE'
            }).then(response => {
                if (response.ok) {
                    // Redirect alla pagina della materia
                    window.location.href = `/materia/{{ materia.id }}`;
                } else {
                    alert('Errore durante l\'eliminazione dell\'argomento');
                }
            }).catch(error => {
                console.error('Errore:', error);
                alert('Errore durante l\'eliminazione dell\'argomento');
            }).finally(() => {
                document.getElementById('confirm-delete-argomento-modal').style.display = 'none';
            });
        }
          // Variables for search navigation
        let currentSearchMatches = [];
        let currentMatchIndex = -1;
        
        // Funzione per cercare nel contenuto
        function searchInContent() {
            const query = document.getElementById('search-in-content').value.toLowerCase().trim();
            const contentElement = document.getElementById('rendered-markdown');
            const summaryElement = document.getElementById('search-results-summary');
            const navigationElement = document.getElementById('search-navigation');
            const counterElement = document.getElementById('search-counter');
            
            if (!contentElement) return;
            
            if (!query) {
                // Reset highlights and navigation
                resetHighlights();
                summaryElement.style.display = 'none';
                navigationElement.style.display = 'none';
                currentSearchMatches = [];
                currentMatchIndex = -1;
                return;
            }
            
            // Remove existing highlights
            resetHighlights();
            
            // Find and highlight matches
            const matches = highlightTextInElement(contentElement, query);
            
            // Update matches array
            currentSearchMatches = Array.from(contentElement.querySelectorAll('.highlight-match'));
            currentMatchIndex = currentSearchMatches.length > 0 ? 0 : -1;
            
            // Show summary and navigation
            if (matches > 0) {
                summaryElement.innerHTML = `Trovati ${matches} risultati per "${query}"`;
                summaryElement.style.display = 'block';
                
                // Show navigation controls
                navigationElement.style.display = 'flex';
                updateNavigationState();
                
                // Highlight first match and scroll to it
                highlightCurrentMatch();
                scrollToCurrentMatch();
            } else {
                summaryElement.innerHTML = `Nessun risultato trovato per "${query}"`;
                summaryElement.style.display = 'block';
                navigationElement.style.display = 'none';
                currentSearchMatches = [];
                currentMatchIndex = -1;
            }
        }
        
        // Update navigation counter and button states
        function updateNavigationState() {
            const counterElement = document.getElementById('search-counter');
            const prevBtn = document.getElementById('search-prev');
            const nextBtn = document.getElementById('search-next');
            
            if (currentSearchMatches.length === 0) {
                counterElement.textContent = '0/0';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }
            
            counterElement.textContent = `${currentMatchIndex + 1}/${currentSearchMatches.length}`;
            prevBtn.disabled = currentMatchIndex <= 0;
            nextBtn.disabled = currentMatchIndex >= currentSearchMatches.length - 1;
        }
        
        // Highlight current match with special style
        function highlightCurrentMatch() {
            // Remove previous current highlight
            currentSearchMatches.forEach(match => match.classList.remove('current-match'));
            
            // Add current highlight
            if (currentMatchIndex >= 0 && currentMatchIndex < currentSearchMatches.length) {
                currentSearchMatches[currentMatchIndex].classList.add('current-match');
            }
        }
        
        // Scroll to current match
        function scrollToCurrentMatch() {
            if (currentMatchIndex >= 0 && currentMatchIndex < currentSearchMatches.length) {
                const currentMatch = currentSearchMatches[currentMatchIndex];
                currentMatch.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center',
                    inline: 'nearest'
                });
            }
        }
        
        // Navigate to previous match
        function navigateToPrevious() {
            if (currentMatchIndex > 0) {
                currentMatchIndex--;
                updateNavigationState();
                highlightCurrentMatch();
                scrollToCurrentMatch();
            }
        }
        
        // Navigate to next match
        function navigateToNext() {
            if (currentMatchIndex < currentSearchMatches.length - 1) {
                currentMatchIndex++;
                updateNavigationState();
                highlightCurrentMatch();
                scrollToCurrentMatch();
            }
        }
        
        // Funzione per rimuovere gli highlight
        function resetHighlights() {
            const contentElement = document.getElementById('rendered-markdown');
            if (!contentElement) return;
            
            const highlights = contentElement.querySelectorAll('.highlight-match');
            highlights.forEach(highlight => {
                const parent = highlight.parentNode;
                parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
                parent.normalize();
            });
        }
        
        // Funzione per evidenziare il testo
        function highlightTextInElement(element, query) {
            let matchCount = 0;
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                textNodes.push(node);
            }
            
            textNodes.forEach(textNode => {
                const text = textNode.textContent;
                const lowerText = text.toLowerCase();
                const queryIndex = lowerText.indexOf(query);
                
                if (queryIndex !== -1) {
                    const beforeText = text.substring(0, queryIndex);
                    const matchText = text.substring(queryIndex, queryIndex + query.length);
                    const afterText = text.substring(queryIndex + query.length);
                    
                    const fragment = document.createDocumentFragment();
                    
                    if (beforeText) {
                        fragment.appendChild(document.createTextNode(beforeText));
                    }
                    
                    const highlight = document.createElement('span');
                    highlight.className = 'highlight-match';
                    highlight.textContent = matchText;
                    fragment.appendChild(highlight);
                    matchCount++;
                    
                    if (afterText) {
                        fragment.appendChild(document.createTextNode(afterText));
                    }
                    
                    textNode.parentNode.replaceChild(fragment, textNode);
                }
            });
              return matchCount;
        }        // Enhanced file input handling for both file inputs
        document.addEventListener('DOMContentLoaded', function() {
            // Handle editor file input
            const editorFileInput = document.getElementById('file_content');
            const editorFileDisplay = document.getElementById('file_display_editor');
            if (editorFileInput && editorFileDisplay) {
                setupFileInput(editorFileInput, editorFileDisplay);
            }

            // Handle allegato file input
            const allegatoFileInput = document.getElementById('allegato_file');
            const allegatoFileDisplay = document.getElementById('file_display_allegato');
            if (allegatoFileInput && allegatoFileDisplay) {
                setupFileInput(allegatoFileInput, allegatoFileDisplay);
            }
        });

        function setupFileInput(fileInput, fileDisplay) {
            // Make the display area clickable
            fileDisplay.addEventListener('click', function() {
                fileInput.click();
            });

            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                const wrapper = fileInput.closest('.file-input-wrapper');
                
                if (file) {
                    wrapper.classList.add('has-file');
                    fileDisplay.querySelector('.file-icon').textContent = '‚úÖ';
                    fileDisplay.querySelector('.file-text').textContent = `File selezionato: ${file.name}`;
                    fileDisplay.querySelector('.file-subtext').textContent = 'Clicca per cambiare file';
                    fileInput.title = `File selezionato: ${file.name}`;
                } else {
                    wrapper.classList.remove('has-file');
                    fileDisplay.querySelector('.file-icon').textContent = 'üìé';
                    fileDisplay.querySelector('.file-text').textContent = 'Scegli file o trascina qui';
                    fileDisplay.querySelector('.file-subtext').textContent = 'Clicca per selezionare un file dal tuo computer';
                    fileInput.title = '';
                }
            });

            // Drag and drop support
            fileDisplay.addEventListener('dragover', function(e) {
                e.preventDefault();
                fileDisplay.style.borderColor = '#4f8cff';
                fileDisplay.style.backgroundColor = '#f0f4ff';
            });

            fileDisplay.addEventListener('dragleave', function(e) {
                e.preventDefault();
                fileDisplay.style.borderColor = '';
                fileDisplay.style.backgroundColor = '';
            });

            fileDisplay.addEventListener('drop', function(e) {
                e.preventDefault();
                fileDisplay.style.borderColor = '';
                fileDisplay.style.backgroundColor = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {                fileInput.files = files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });
        }

        // === COLLEGAMENTI FUNCTIONALITY ===
        let selectedEndpoint = null;
        let selectedArgomento1 = { id: {{ argomento.id }}, titolo: "{{ argomento.titolo }}", materia: "{{ materia.nome }}", colore: "{{ materia.colore }}" };
        let selectedArgomento2 = null;

        function showCollegamentoModal(argomentoId) {
            // Pre-populate first argument
            selectedArgomento1 = { 
                id: argomentoId, 
                titolo: "{{ argomento.titolo }}", 
                materia: "{{ materia.nome }}", 
                colore: "{{ materia.colore }}" 
            };
            
            document.getElementById('collegamento-modal').style.display = 'flex';
            
            // Clear form
            document.getElementById('collegamento-form').reset();
            clearArgomento(2);
        }

        function closeCollegamentoModal() {
            document.getElementById('collegamento-modal').style.display = 'none';
            document.getElementById('collegamento-form').reset();
            clearArgomento(2);
        }

        function showMaterieSelector(endpoint) {
            selectedEndpoint = endpoint;
            document.getElementById('materie-selector-modal').style.display = 'flex';
            loadMaterie();
        }

        function closeMaterieSelector() {
            document.getElementById('materie-selector-modal').style.display = 'none';
            document.getElementById('materie-list').style.display = 'block';
            document.getElementById('argomenti-list').style.display = 'none';
        }

        function clearArgomento(endpoint) {
            if (endpoint === 1) {
                selectedArgomento1 = null;
                document.getElementById('selected-argomento-1').style.display = 'none';
            } else {
                selectedArgomento2 = null;
                document.getElementById('selected-argomento-2').style.display = 'none';
                document.getElementById('no-selection-2').style.display = 'block';
            }
        }        function loadMaterie() {
            const materieList = document.getElementById('materie-list');
            if (!materieList) {
                console.error('‚ùå materie-list element not found');
                return;
            }
            
            // Add loading state
            materieList.className = 'materie-list loading';
            materieList.innerHTML = '';
            
            fetch('/api/materie')
                .then(response => response.json())
                .then(materie => {
                    // Remove loading state
                    materieList.className = 'materie-list';
                    materieList.innerHTML = '';
                    
                    if (materie.length === 0) {
                        materieList.className = 'materie-list empty';
                        materieList.innerHTML = '<p>Nessuna materia trovata</p>';
                        return;
                    }
                    
                    materie.forEach(materia => {
                        const materiaCard = document.createElement('div');
                        materiaCard.className = 'materia-card';
                        // Set CSS custom property for border color
                        materiaCard.style.setProperty('--materia-color', materia.colore);
                        materiaCard.innerHTML = `
                            <h3>${materia.nome}</h3>
                        `;
                        materiaCard.onclick = () => loadArgomenti(materia.id, materia.nome, materia.colore);
                        materieList.appendChild(materiaCard);
                    });
                })
                .catch(error => {
                    console.error('Error loading materie:', error);
                    materieList.className = 'materie-list empty';
                    materieList.innerHTML = '<p>Errore nel caricamento delle materie</p>';
                });
        }function loadArgomenti(materiaId, materiaNome, materiaColore) {
            fetch(`/api/argomenti/materia/${materiaId}`)
                .then(response => response.json())
                .then(argomenti => {
                    allArgomentiData = argomenti; // Store for search
                    const argomentiGrid = document.getElementById('argomenti-grid');
                    argomentiGrid.innerHTML = '';
                    
                    argomenti.forEach(argomento => {
                        const argomentoCard = document.createElement('div');
                        argomentoCard.className = 'argomento-card';
                        
                        // Set CSS custom property for materia color
                        argomentoCard.style.setProperty('--materia-color', materiaColore);
                        
                        argomentoCard.innerHTML = `
                            <div class="argomento-header">
                                <h4>${argomento.titolo}</h4>
                                <span class="materia-badge" style="background-color: ${materiaColore}">${materiaNome}</span>
                            </div>
                            <div class="argomento-preview">${argomento.contenuto_md ? argomento.contenuto_md.substring(0, 100) + '...' : 'Nessun contenuto'}</div>
                        `;
                        argomentoCard.onclick = () => selectArgomento(argomento.id, argomento.titolo, materiaNome, materiaColore);
                        argomentiGrid.appendChild(argomentoCard);
                    });
                      document.getElementById('materie-list').style.display = 'none';
                    document.getElementById('argomenti-list').style.display = 'block';
                    
                    // Setup search functionality
                    setupArgomentiModalSearch();
                    
                    // Clear search inputs when switching materia
                    document.getElementById('argomenti-search').value = '';
                    document.getElementById('content-search').value = '';
                })
                .catch(error => console.error('Error loading argomenti:', error));
        }

        function showMaterieList() {
            document.getElementById('materie-list').style.display = 'block';
            document.getElementById('argomenti-list').style.display = 'none';
        }

        function selectArgomento(id, titolo, materia, colore) {
            if (selectedEndpoint === 1) {
                selectedArgomento1 = { id, titolo, materia, colore };
                updateSelectedArgomento(1, titolo, materia, colore);
            } else {
                selectedArgomento2 = { id, titolo, materia, colore };
                updateSelectedArgomento(2, titolo, materia, colore);
            }
            closeMaterieSelector();
        }

        function updateSelectedArgomento(endpoint, titolo, materia, colore) {
            const container = document.getElementById(`selected-argomento-${endpoint}`);
            const noSelection = document.getElementById(`no-selection-${endpoint}`);
            
            container.querySelector('.materia-badge').textContent = materia;
            container.querySelector('.materia-badge').style.backgroundColor = colore;
            container.querySelector('.argomento-title').textContent = titolo;
            
            container.style.display = 'flex';
            if (noSelection) noSelection.style.display = 'none';
        }

        // Handle collegamento form submission
        document.getElementById('collegamento-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!selectedArgomento1 || !selectedArgomento2) {
                alert('Seleziona entrambi gli argomenti per creare il collegamento.');
                return;
            }
            
            const formData = new FormData();
            formData.append('titolo', document.getElementById('collegamento-titolo').value);
            formData.append('id_argomento1', selectedArgomento1.id);
            formData.append('id_argomento2', selectedArgomento2.id);
            formData.append('dettagli', document.getElementById('collegamento-dettagli').value);
            formData.append('etichetta_qualita', document.getElementById('collegamento-qualita').value);
              fetch('/add_collegamento', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeCollegamentoModal();
                    // Reload sidebar connections
                    loadSidebarConnections();
                    // Show success message
                    showNotification('Collegamento creato con successo!', 'success');                } else {
                    showNotification('Errore nella creazione del collegamento: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Errore nella creazione del collegamento.', 'error');
            });
        });
        
        // === NOTIFICATION SYSTEM ===
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }            }, 4000);        }        // === LEFT SIDEBAR FUNCTIONALITY ===
        function toggleSidebar() {
            const sidebar = document.getElementById('left-sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleIcon = document.querySelector('.toggle-icon');
            
            sidebar.classList.toggle('open');
            mainContent.classList.toggle('sidebar-open');
            
            // Create/remove overlay for mobile
            if (sidebar.classList.contains('open')) {
                toggleIcon.textContent = '‚úñÔ∏è';
                loadSidebarConnections();
                
                // Add overlay on mobile
                if (window.innerWidth <= 768) {
                    const overlay = document.createElement('div');
                    overlay.className = 'sidebar-overlay';
                    overlay.onclick = () => toggleSidebar();
                    document.body.appendChild(overlay);
                }
            } else {
                toggleIcon.textContent = 'üìã';
                // Remove overlay
                const overlay = document.querySelector('.sidebar-overlay');
                if (overlay) {
                    overlay.remove();
                }
            }
        }

        function loadSidebarConnections() {
            fetch('/api/collegamenti')
                .then(response => response.json())
                .then(collegamenti => {
                    updateSidebarConnections(collegamenti);
                })
                .catch(error => console.error('Error loading sidebar connections:', error));
        }

        function updateSidebarConnections(collegamenti) {
            const sidebarMaterie = document.getElementById('sidebar-materie');
            
            // Group connections by materia
            const materieMap = new Map();
            
            collegamenti.forEach(collegamento => {
                // Add to materia 1
                const materia1 = collegamento.materia1_nome;
                if (!materieMap.has(materia1)) {
                    materieMap.set(materia1, {
                        nome: materia1,
                        colore: collegamento.materia1_colore,
                        collegamenti: []
                    });
                }
                materieMap.get(materia1).collegamenti.push(collegamento);
                
                // Add to materia 2 if different
                const materia2 = collegamento.materia2_nome;
                if (materia2 !== materia1) {
                    if (!materieMap.has(materia2)) {
                        materieMap.set(materia2, {
                            nome: materia2,
                            colore: collegamento.materia2_colore,
                            collegamenti: []
                        });
                    }
                    materieMap.get(materia2).collegamenti.push(collegamento);
                }
            });
            
            // Generate sidebar HTML
            sidebarMaterie.innerHTML = '';
            
            materieMap.forEach((materiaData, materiaNome) => {
                const materiaDiv = document.createElement('div');
                materiaDiv.className = 'sidebar-materia';
                  materiaDiv.innerHTML = `
                    <div class="sidebar-materia-header" onclick="toggleMateriaConnections(this)">
                        <div class="sidebar-materia-title">
                            <span class="sidebar-materia-badge" style="background-color: ${materiaData.colore}"></span>
                            ${materiaNome}
                        </div>
                        <span class="sidebar-materia-toggle">‚ñ∂</span>
                    </div>
                    <div class="sidebar-search-group">
                        <div class="sidebar-search">
                            <input type="text" class="sidebar-search-input" placeholder="Cerca collegamento..." oninput="filterCollegamenti(this, 'collegamento')">
                            <img src="/static/icons/search-icon.svg" class="sidebar-search-icon" width="16" height="16">
                        </div>
                        <div class="sidebar-search">
                            <input type="text" class="sidebar-search-input" placeholder="Cerca argomento..." oninput="filterCollegamenti(this, 'argomento')">
                            <img src="/static/icons/search-icon.svg" class="sidebar-search-icon" width="16" height="16">
                        </div>
                    </div>
                    <div class="sidebar-collegamenti">
                        ${materiaData.collegamenti.map(conn => `
                            <div class="sidebar-collegamento" data-titolo="${conn.titolo.toLowerCase()}" data-argomenti="${conn.argomento1_titolo.toLowerCase()} ${conn.argomento2_titolo.toLowerCase()}" onclick="viewCollegamento(${conn.id})">
                                <div class="collegamento-title">${conn.titolo}</div>
                                <div class="collegamento-endpoints">
                                    ${conn.argomento1_titolo} ‚Üî ${conn.argomento2_titolo}
                                </div>
                                <div class="collegamento-quality quality-${conn.etichetta_qualita.replace(/\s+/g, '-').replace('collegamento-', '')}">${conn.etichetta_qualita}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                  sidebarMaterie.appendChild(materiaDiv);
            });
        }
        
        function toggleMateriaConnections(headerElement) {
            const materiaDiv = headerElement.parentElement;
            materiaDiv.classList.toggle('expanded');
        }

        function viewCollegamento(collegamentoId) {
            showSidebarCollegamentoModal(collegamentoId);
        }

        function filterCollegamenti(inputElement, filterType) {
            const searchTerm = inputElement.value.toLowerCase().trim();
            const materiaDiv = inputElement.closest('.sidebar-materia');
            const collegamenti = materiaDiv.querySelectorAll('.sidebar-collegamento');
            
            collegamenti.forEach(collegamento => {
                let shouldShow = false;
                
                // Get original data if not stored
                if (!collegamento.originalData) {
                    const titleElement = collegamento.querySelector('.collegamento-title');
                    const endpointsElement = collegamento.querySelector('.collegamento-endpoints');
                    collegamento.originalData = {
                        title: titleElement ? titleElement.textContent : '',
                        endpoints: endpointsElement ? endpointsElement.textContent : ''
                    };
                }
                
                if (filterType === 'collegamento') {
                    // Filter by connection title
                    const titolo = collegamento.getAttribute('data-titolo');
                    shouldShow = titolo.includes(searchTerm);
                    
                    // Highlight title if showing and search term exists
                    const titleElement = collegamento.querySelector('.collegamento-title');
                    if (titleElement) {
                        if (shouldShow && searchTerm) {
                            titleElement.innerHTML = highlightText(collegamento.originalData.title, searchTerm);
                        } else {
                            titleElement.textContent = collegamento.originalData.title;
                        }
                    }
                } else if (filterType === 'argomento') {
                    // Filter by argument titles
                    const argomenti = collegamento.getAttribute('data-argomenti');
                    shouldShow = argomenti.includes(searchTerm);
                    
                    // Highlight endpoints if showing and search term exists
                    const endpointsElement = collegamento.querySelector('.collegamento-endpoints');
                    if (endpointsElement) {
                        if (shouldShow && searchTerm) {
                            endpointsElement.innerHTML = highlightText(collegamento.originalData.endpoints, searchTerm);
                        } else {
                            endpointsElement.textContent = collegamento.originalData.endpoints;
                        }
                    }
                }
                
                collegamento.style.display = shouldShow ? 'block' : 'none';
            });
        }

        //Load sidebar connections on page load        
        document.addEventListener('DOMContentLoaded', function() {
            loadSidebarConnections();
        });

        // Modal dettagli collegamento da sidebar
function showSidebarCollegamentoModal(id) {
  fetch('/api/collegamenti')
    .then(r => r.json())
    .then(collegamenti => {
      const c = collegamenti.find(x => x.id === id);
      if (!c) return;
      let html = `
        <div class='mini-collegamento-card'>
          <div class='collegamento-header'><h4>${c.titolo}</h4></div>
          <div class='collegamento-argomenti'>
            <div class='argomento-tag' style='border:2.5px solid ${c.materia1_colore}'>
              <a href='/argomento/${c.id_argomento1}'>${c.argomento1_titolo}</a>
              <span class='materia-name'>${c.materia1_nome}</span>
            </div>
            <div class='collegamento-arrow'>‚ü∑</div>
            <div class='argomento-tag' style='border:2.5px solid ${c.materia2_colore}'>
              <a href='/argomento/${c.id_argomento2}'>${c.argomento2_titolo}</a>
              <span class='materia-name'>${c.materia2_nome}</span>
            </div>
          </div>
          <div class='collegamento-footer'>
            <span class='etichetta-qualita ${c.etichetta_qualita.replace(/ /g,'-').toLowerCase()}'>${c.etichetta_qualita}</span>
          </div>
          <div class='collegamento-dettagli' style='margin-top:1em;'>
            <div class='markdown-content'>${marked.parse(c.dettagli||'')}</div>
          </div>
        </div>      `;
      document.getElementById('sidebar-collegamento-body').innerHTML = html;
      document.getElementById('sidebar-collegamento-modal').style.display = 'flex';
    });
}
function closeSidebarCollegamentoModal() {
  document.getElementById('sidebar-collegamento-modal').style.display = 'none';
}        // Helper functions for text highlighting
        function highlightText(text, query) {
            if (!query || !text) return text;
            
            const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
            return text.replace(regex, '<mark class="argomenti-modal-highlight">$1</mark>');
        }
          function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
          // Function to handle editor size controls
        function setupEditorSizeControls() {
            let isFullscreen = false;
            
            // Get the fullscreen toggle button
            const toggleBtn = document.getElementById('fullscreen-toggle');
            const editorSection = document.getElementById('markdown-editor-section');
            
            if (!toggleBtn || !editorSection) return;
            
            // Add click handler to toggle button
            toggleBtn.addEventListener('click', function() {
                isFullscreen = !isFullscreen;
                
                // Toggle fullscreen class and active state
                if (isFullscreen) {
                    editorSection.classList.add('editor-large');
                    toggleBtn.classList.add('active');
                    // Add escape key listener
                    addFullscreenEscapeListener();
                } else {
                    editorSection.classList.remove('editor-large');
                    toggleBtn.classList.remove('active');
                    // Remove escape key listener
                    removeFullscreenEscapeListener();
                }
                
                // Refresh CodeMirror if it exists
                refreshCodeMirror();
            });
            
            // Function to refresh CodeMirror
            function refreshCodeMirror() {
                const textarea = document.getElementById('contenuto_md');
                if (textarea && textarea.nextElementSibling && textarea.nextElementSibling.classList.contains('CodeMirror')) {
                    const cm = textarea.nextElementSibling.CodeMirror;
                    if (cm) {
                        setTimeout(() => cm.refresh(), 100);
                    }
                }
            }
            
            // Escape key handler for fullscreen mode
            let escapeHandler = null;
            
            function addFullscreenEscapeListener() {
                escapeHandler = function(e) {
                    if (e.key === 'Escape' && isFullscreen) {
                        // Click the toggle button to exit fullscreen
                        toggleBtn.click();
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            }
            
            function removeFullscreenEscapeListener() {
                if (escapeHandler) {
                    document.removeEventListener('keydown', escapeHandler);
                    escapeHandler = null;
                }
            }
        }

        // === ARGOMENTI MODAL SEARCH FUNCTIONALITY ===
        let allArgomentiData = []; // Store all loaded argomenti for search        
        function setupArgomentiModalSearch() {
            const argomentiSearch = document.getElementById('argomenti-search');
            const contentSearch = document.getElementById('content-search');
            
            if (argomentiSearch) {
                argomentiSearch.addEventListener('input', function() {
                    filterArgomentiInModal(this.value, 'title');
                });
            }
            
            if (contentSearch) {
                contentSearch.addEventListener('input', function() {
                    filterArgomentiInModal(this.value, 'content');
                });
            }
        }

        function filterArgomentiInModal(searchTerm, searchType) {
            const argomentiGrid = document.getElementById('argomenti-grid');
            const argomentoCards = argomentiGrid.querySelectorAll('.argomento-card');
            
            searchTerm = searchTerm.toLowerCase().trim();
              argomentoCards.forEach((card, index) => {
                let shouldShow = false;
                
                // Always reset highlighting first (fix per il problema della sottolineatura persistente)
                const titleElement = card.querySelector('.argomento-header h4');
                const previewElement = card.querySelector('.argomento-preview');
                
                if (!titleElement || !previewElement) {
                    console.warn('‚ùå Title or preview element not found in argomento card');
                    return;
                }
                
                // Store original text if not already stored
                if (!titleElement.originalText) {
                    titleElement.originalText = titleElement.textContent;
                }
                if (!previewElement.originalText) {
                    previewElement.originalText = previewElement.textContent;
                }
                
                // Reset highlighting sempre all'inizio
                titleElement.innerHTML = titleElement.originalText;
                previewElement.innerHTML = previewElement.originalText;
                
                if (!searchTerm) {
                    // Se non c'√® termine di ricerca, mostra tutto
                    shouldShow = true;
                } else {
                    const argomentoData = allArgomentiData[index];
                    
                    if (searchType === 'title') {
                        // Search only in argomento titles
                        const title = titleElement.originalText.toLowerCase();
                        
                        if (title.includes(searchTerm)) {
                            shouldShow = true;
                            titleElement.innerHTML = highlightText(titleElement.originalText, searchTerm);
                            previewElement.innerHTML = previewElement.originalText;
                        }
                    } else if (searchType === 'content') {
                        // Search in the full content, not just the preview
                        const fullContent = (argomentoData?.contenuto_md || '').toLowerCase();
                        
                        if (fullContent.includes(searchTerm)) {
                            shouldShow = true;
                            titleElement.innerHTML = titleElement.originalText;
                            
                            // Find the matching portion in the full content for highlighting
                            const searchIndex = fullContent.indexOf(searchTerm);
                            if (searchIndex !== -1) {
                                // Extract a snippet around the match for display
                                const start = Math.max(0, searchIndex - 50);
                                const end = Math.min(fullContent.length, searchIndex + searchTerm.length + 50);
                                let snippet = argomentoData.contenuto_md.substring(start, end);
                                
                                // Add ellipsis if needed
                                if (start > 0) snippet = '...' + snippet;
                                if (end < fullContent.length) snippet = snippet + '...';
                                
                                // Update preview with highlighted snippet
                                previewElement.innerHTML = highlightText(snippet, searchTerm);
                            } else {
                                // Fallback to original preview with highlighting if match was in processed content
                                previewElement.innerHTML = highlightText(previewElement.originalText, searchTerm);
                            }
                        }
                    }
                }
                
                // Applica la visibilit√† in modo pi√π robusto
                if (shouldShow) {
                    card.style.display = 'block';
                    card.style.visibility = 'visible';
                    card.style.opacity = '1';
                } else {
                    card.style.display = 'none';
                    card.style.visibility = 'hidden';
                    card.style.opacity = '0';
                }
            });
        }

        function checkArgomentoInConnections(card, searchTerm) {
            // This is a simplified implementation
            // In a real scenario, you would fetch connection data and check if the argomento
            // is involved in connections that match the search term
            const title = card.querySelector('.argomento-header h4').originalText || 
                         card.querySelector('.argomento-header h4').textContent;
            return title.toLowerCase().includes(searchTerm);
        }
    </script>
</body>
</html>
